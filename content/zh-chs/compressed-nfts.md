---
title: å‹ç¼© NFTs
objectives:
- ä½¿ç”¨ Metaplex çš„ Bubblegum ç¨‹åºåˆ›å»ºä¸€ä¸ªå‹ç¼©çš„ NFT é›†åˆ
- ä½¿ç”¨ Bubblegum TS SDK é“¸é€ å‹ç¼©çš„ NFTs
- ä½¿ç”¨ Bubblegum TS SDK è½¬ç§»å‹ç¼©çš„ NFTs
- ä½¿ç”¨ Read API è¯»å–å‹ç¼©çš„ NFT æ•°æ®
---

# æ€»ç»“

- **å‹ç¼© NFTsï¼ˆcNFTsï¼‰** ä½¿ç”¨ **çŠ¶æ€å‹ç¼©** å¯¹ NFT æ•°æ®è¿›è¡Œå“ˆå¸Œï¼Œå¹¶å°†å“ˆå¸Œå­˜å‚¨åœ¨é“¾ä¸Šçš„ä¸€ä¸ªè´¦æˆ·ä¸­ï¼Œä½¿ç”¨ **å¹¶å‘ Merkle æ ‘** ç»“æ„ã€‚
- cNFT æ•°æ®çš„å“ˆå¸Œä¸èƒ½ç”¨äºæ¨æ–­ cNFT æ•°æ®ï¼Œä½†å¯ä»¥ç”¨äº **éªŒè¯** æ‰€è§çš„ cNFT æ•°æ®æ˜¯å¦æ­£ç¡®ã€‚
- æ”¯æŒçš„ RPC æä¾›å•†åœ¨ cNFT é“¸é€ æ—¶ä¼š **ç´¢å¼•** é“¾ä¸‹ cNFT æ•°æ®ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥ä½¿ç”¨ **Read API** è®¿é—®æ•°æ®ã€‚
- **Metaplex Bubblegum ç¨‹åº** æ˜¯ **çŠ¶æ€å‹ç¼©** ç¨‹åºä¹‹ä¸Šçš„ä¸€ä¸ªæŠ½è±¡ï¼Œä½¿æ‚¨æ›´ç®€å•åœ°åˆ›å»ºã€é“¸é€ å’Œç®¡ç† cNFT é›†åˆã€‚

# æ¦‚è¿°

å‹ç¼© NFTsï¼ˆCompressed NFTsï¼ŒcNFTsï¼‰æ­£å¦‚å…¶åç§°æ‰€ç¤ºï¼šNFT çš„ç»“æ„å ç”¨çš„è´¦æˆ·å­˜å‚¨ç©ºé—´ï¼ˆaccount storageï¼‰æ¯”ä¼ ç»Ÿ NFT æ›´å°‘ã€‚å‹ç¼© NFTs åˆ©ç”¨äº†ä¸€ç§ç§°ä¸º **çŠ¶æ€å‹ç¼©ï¼ˆState Compressionï¼‰** çš„æ¦‚å¿µï¼Œä»¥æå¤§åœ°é™ä½æˆæœ¬çš„æ–¹å¼å­˜å‚¨æ•°æ®ã€‚

Solana çš„äº¤æ˜“æˆæœ¬éå¸¸ä¾¿å®œï¼Œä»¥è‡³äºå¤§å¤šæ•°ç”¨æˆ·ä»æœªè€ƒè™‘è¿‡å¤§è§„æ¨¡é“¸é€  NFTs å¯ä»¥æ˜¯å¤šä¹ˆæ˜‚è´µã€‚è®¾ç½®å¹¶é“¸é€  100 ä¸‡ä¸ªä¼ ç»Ÿ NFTs çš„æˆæœ¬çº¦ä¸º 24,000 SOLã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œç»“æ„åŒ–çš„ cNFTs å¯ä»¥ä½¿å¾—ç›¸åŒçš„è®¾ç½®å’Œé“¸é€ æˆæœ¬é™ä½åˆ° 10 SOL æˆ–æ›´ä½ã€‚è¿™æ„å‘³ç€ä»»ä½•å¤§è§„æ¨¡ä½¿ç”¨ NFTs çš„äººéƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨ cNFTs è€Œä¸æ˜¯ä¼ ç»Ÿ NFTs å°†æˆæœ¬å‰Šå‡è¶…è¿‡ 1000 å€ã€‚

ç„¶è€Œï¼Œä½¿ç”¨ cNFTs å¯èƒ½æœ‰äº›æ£˜æ‰‹ã€‚æœ€ç»ˆï¼Œå¤„ç†å®ƒä»¬æ‰€éœ€çš„å·¥å…·å°†è¢«ä»åº•å±‚æŠ€æœ¯ä¸­å……åˆ†æŠ½è±¡å‡ºæ¥ï¼Œä»¥è‡³äºä¼ ç»Ÿ NFTs å’Œ cNFTs ä¹‹é—´çš„å¼€å‘äººå‘˜ä½“éªŒå°†å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ä½†æ˜¯ç›®å‰ï¼Œæ‚¨ä»ç„¶éœ€è¦ç†è§£åº•å±‚æ‹¼å›¾ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ·±å…¥æ¢è®¨ï¼

## cNFTs çš„ç†è®ºæ¦‚è¿°

ä¸ä¼ ç»Ÿ NFTs ç›¸å…³çš„å¤§éƒ¨åˆ†æˆæœ¬å½’ç»“ä¸ºè´¦æˆ·å­˜å‚¨ç©ºé—´ï¼ˆaccount storage spaceï¼‰ã€‚å‹ç¼© NFTs ä½¿ç”¨ä¸€ç§ç§°ä¸ºçŠ¶æ€å‹ç¼©çš„æ¦‚å¿µï¼Œå°†æ•°æ®å­˜å‚¨åœ¨åŒºå—é“¾æ›´ä¾¿å®œçš„ **è´¦æœ¬çŠ¶æ€ï¼ˆledger stateï¼‰** ä¸­ï¼Œåªä½¿ç”¨æ›´æ˜‚è´µçš„è´¦æˆ·ç©ºé—´æ¥å­˜å‚¨æ•°æ®çš„â€œæŒ‡çº¹ï¼ˆfingerprintï¼‰â€æˆ– **å“ˆå¸Œï¼ˆhashï¼‰**ã€‚è¿™ä¸ªå“ˆå¸Œå…è®¸æ‚¨é€šè¿‡åŠ å¯†çš„æ–¹å¼éªŒè¯æ•°æ®æ˜¯å¦è¢«ç¯¡æ”¹ã€‚

ä¸ºäº†å­˜å‚¨å“ˆå¸Œå¹¶å¯ç”¨éªŒè¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ç§ç§°ä¸º **å¹¶å‘ Merkle æ ‘** çš„ç‰¹æ®ŠäºŒè¿›åˆ¶æ ‘ç»“æ„ã€‚è¿™ä¸ªæ ‘ç»“æ„è®©æˆ‘ä»¬ä»¥ç¡®å®šæ€§çš„æ–¹å¼å°†æ•°æ®ä¸€èµ·å“ˆå¸Œï¼Œè®¡ç®—å‡ºä¸€ä¸ªå•ä¸€çš„ã€æœ€ç»ˆçš„å“ˆå¸Œå€¼ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨é“¾ä¸Šã€‚è¿™ä¸ªæœ€ç»ˆçš„å“ˆå¸Œå€¼çš„å¤§å°æ˜æ˜¾å°äºæ‰€æœ‰åŸå§‹æ•°æ®çš„æ€»å’Œï¼Œå› æ­¤ç§°ä¹‹ä¸ºâ€œå‹ç¼©â€ã€‚è¿™ä¸ªè¿‡ç¨‹çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. å–ä»»æ„ä¸€æ®µæ•°æ®ã€‚
2. åˆ›å»ºè¿™äº›æ•°æ®çš„å“ˆå¸Œå€¼ã€‚
3. å°†è¿™ä¸ªå“ˆå¸Œå€¼ä½œä¸ºä¸€ä¸ªâ€œå¶ï¼ˆleafï¼‰å­â€å­˜å‚¨åœ¨æ ‘çš„åº•éƒ¨ã€‚
4. ç„¶åå°†æ¯ä¸€å¯¹å¶å­è¿›è¡Œå“ˆå¸Œï¼Œåˆ›å»ºä¸€ä¸ªâ€œåˆ†æ”¯ï¼ˆbranchï¼‰â€ã€‚
5. ç„¶åå°†æ¯ä¸ªåˆ†æ”¯è¿›è¡Œå“ˆå¸Œã€‚
6. ä¸æ–­åœ°å‘æ ‘ä¸Šçˆ¬è¡Œï¼Œå¹¶å°†ç›¸é‚»çš„åˆ†æ”¯è¿›è¡Œå“ˆå¸Œã€‚
7. å½“åˆ°è¾¾æ ‘çš„é¡¶éƒ¨æ—¶ï¼Œäº§ç”Ÿä¸€ä¸ªæœ€ç»ˆçš„â€œæ ¹å“ˆå¸Œï¼ˆroot hashï¼‰â€ã€‚
8. å°†æ ¹å“ˆå¸Œä½œä¸ºå¯éªŒè¯çš„è¯æ˜å­˜å‚¨åœ¨é“¾ä¸Šï¼Œè¯æ˜äº†æ¯ä¸ªå¶å­ä¸­çš„æ•°æ®ã€‚
9. ä»»ä½•æƒ³è¦éªŒè¯ä»–ä»¬æ‹¥æœ‰çš„æ•°æ®æ˜¯å¦ä¸â€œçœŸç›¸æºï¼ˆsource of truthï¼‰â€åŒ¹é…çš„äººéƒ½å¯ä»¥é€šè¿‡ç›¸åŒçš„è¿‡ç¨‹è¿›è¡Œï¼Œå¹¶æ¯”è¾ƒæœ€ç»ˆçš„å“ˆå¸Œå€¼ï¼Œè€Œæ— éœ€å°†æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨é“¾ä¸Šã€‚

ä¸Šè¿°å†…å®¹æœªè§£å†³çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœæ— æ³•ä»è´¦æˆ·ä¸­è·å–æ•°æ®ï¼Œå¦‚ä½•ä½¿æ•°æ®å¯ç”¨ã€‚ç”±äºæ­¤å“ˆå¸Œè¿‡ç¨‹å‘ç”Ÿåœ¨é“¾ä¸Šï¼Œæ‰€æœ‰æ•°æ®éƒ½å­˜åœ¨äºè´¦æœ¬çŠ¶æ€ä¸­ï¼Œç†è®ºä¸Šå¯ä»¥é€šè¿‡é‡æ”¾æ•´ä¸ªé“¾çŠ¶æ€ä»åŸç‚¹æ£€ç´¢åŸå§‹äº¤æ˜“ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚ç„¶è€Œï¼Œæ›´ç®€å•ï¼ˆå°½ç®¡ä»ç„¶å¤æ‚ï¼‰çš„æ–¹æ³•æ˜¯è®©ä¸€ä¸ª **ç´¢å¼•å™¨ï¼ˆindexerï¼‰** åœ¨äº¤æ˜“å‘ç”Ÿæ—¶è·Ÿè¸ªå’Œç´¢å¼•è¿™äº›æ•°æ®ã€‚è¿™ç¡®ä¿äº†æœ‰ä¸€ä¸ªé“¾ä¸‹çš„æ•°æ®â€œç¼“å­˜ï¼ˆcacheï¼‰â€ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®å¹¶éšåä¸é“¾ä¸Šçš„æ ¹å“ˆå¸Œè¿›è¡ŒéªŒè¯ã€‚

è¿™ä¸ªè¿‡ç¨‹éå¸¸å¤æ‚ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢ä»‹ç»ä¸€äº›å…³é”®æ¦‚å¿µï¼Œä½†å¦‚æœæ‚¨ä¸€å¼€å§‹ä¸ç†è§£ä¹Ÿä¸ç”¨æ‹…å¿ƒã€‚æˆ‘ä»¬å°†åœ¨[çŠ¶æ€å‹ç¼©è¯¾ç¨‹](./generalized-state-compression.md)ä¸­è®¨è®ºæ›´å¤šç†è®ºï¼Œå¹¶ä¸»è¦ä¸“æ³¨äºåœ¨æœ¬è¯¾ç¨‹ä¸­å°†å…¶åº”ç”¨äº NFTsã€‚å³ä½¿æ‚¨æ²¡æœ‰å®Œå…¨ç†è§£çŠ¶æ€å‹ç¼©æ‹¼å›¾çš„æ¯ä¸€éƒ¨åˆ†ï¼Œåˆ°æœ¬è¯¾ç¨‹ç»“æŸæ—¶ï¼Œæ‚¨ä¹Ÿå°†èƒ½å¤Ÿå¤„ç† cNFTsã€‚

### å¹¶å‘ Merkle æ ‘

**Merkle æ ‘** æ˜¯ä¸€ç§ç”±å•ä¸ªå“ˆå¸Œè¡¨ç¤ºçš„äºŒè¿›åˆ¶æ ‘ç»“æ„ã€‚ç»“æ„ä¸­çš„æ¯ä¸ªå¶å­èŠ‚ç‚¹éƒ½æ˜¯å…¶å†…éƒ¨æ•°æ®çš„å“ˆå¸Œï¼Œè€Œæ¯ä¸ªåˆ†æ”¯éƒ½æ˜¯å…¶å­å¶å­å“ˆå¸Œçš„å“ˆå¸Œã€‚ä¾æ¬¡ï¼Œåˆ†æ”¯ä¹Ÿè¢«ä¸€èµ·å“ˆå¸Œï¼Œç›´åˆ°æœ€ç»ˆåªå‰©ä¸‹ä¸€ä¸ªæ ¹å“ˆå¸Œã€‚

å¯¹å¶å­æ•°æ®çš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šæ”¹å˜æ ¹å“ˆå¸Œã€‚å½“åŒä¸€ slot ä¸­çš„å¤šä¸ªäº¤æ˜“å°è¯•ä¿®æ”¹å¶å­æ•°æ®æ—¶ä¼šäº§ç”Ÿé—®é¢˜ã€‚ç”±äºè¿™äº›äº¤æ˜“å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œé™¤äº†ç¬¬ä¸€ä¸ªäº¤æ˜“å¤–ï¼Œæ‰€æœ‰äº¤æ˜“éƒ½ä¼šå¤±è´¥ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªæ‰§è¡Œçš„äº¤æ˜“å°†ä½¿æ ¹å“ˆå¸Œå’Œä¼ é€’çš„è¯æ˜å¤±æ•ˆã€‚

**å¹¶å‘ Merkle æ ‘ï¼ˆconcurrent merkle treeï¼‰** æ˜¯ä¸€ç§ Merkle æ ‘ï¼Œå®ƒå­˜å‚¨äº†æœ€è¿‘æ›´æ”¹çš„å®‰å…¨å˜æ›´æ—¥å¿—ï¼Œä»¥åŠå®ƒä»¬çš„æ ¹å“ˆå¸Œå’Œç”¨äºæ¨å¯¼å®ƒçš„è¯æ˜ã€‚å½“åŒä¸€ slot ä¸­çš„å¤šä¸ªäº¤æ˜“å°è¯•ä¿®æ”¹å¶å­æ•°æ®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å˜æ›´æ—¥å¿—ä½œä¸ºçœŸç›¸æºï¼Œä»¥å…è®¸å¯¹æ ‘è¿›è¡Œå¹¶å‘æ›´æ”¹ã€‚

åœ¨ä½¿ç”¨å¹¶å‘ Merkle æ ‘æ—¶ï¼Œæœ‰ä¸‰ä¸ªå˜é‡å†³å®šäº†æ ‘çš„å¤§å°ã€åˆ›å»ºæ ‘çš„æˆæœ¬ä»¥åŠå¯ä»¥å¯¹æ ‘è¿›è¡Œçš„å¹¶å‘æ›´æ”¹çš„æ•°é‡ï¼š

1. æœ€å¤§æ·±åº¦ï¼ˆMax depthï¼‰
2. æœ€å¤§ç¼“å†²åŒºå¤§å°ï¼ˆMax buffer sizeï¼‰
3. æ—å† æ·±åº¦ï¼ˆCanopy depthï¼‰

**æœ€å¤§æ·±åº¦** æ˜¯ä»ä»»æ„å¶å­åˆ°æ ‘æ ¹çš„æœ€å¤§è·³æ•°ï¼ˆhopsï¼‰ã€‚ç”±äº Merkle æ ‘æ˜¯äºŒå‰æ ‘ï¼Œæ¯ä¸ªå¶å­åªè¿æ¥åˆ°å¦ä¸€ä¸ªå¶å­ã€‚æœ€å¤§æ·±åº¦å¯ä»¥é€»è¾‘ä¸Šç”¨äºè®¡ç®—æ ‘çš„èŠ‚ç‚¹æ•°ï¼Œå…¬å¼ä¸º `2 ^ maxDepth`ã€‚

**æœ€å¤§ç¼“å†²åŒºå¤§å°** å®é™…ä¸Šæ˜¯åœ¨å•ä¸ª slot å†…å¯¹æ ‘è¿›è¡Œçš„æœ€å¤§å¹¶å‘æ›´æ”¹æ¬¡æ•°ï¼ŒåŒæ—¶æ ¹å“ˆå¸Œä»ç„¶æœ‰æ•ˆã€‚

**æ—å† æ·±åº¦** æ˜¯å­˜å‚¨åœ¨é“¾ä¸Šçš„ç»™å®šè¯æ˜è·¯å¾„çš„è¯æ˜èŠ‚ç‚¹æ•°ã€‚éªŒè¯ä»»ä½•å¶å­éƒ½éœ€è¦å®Œæ•´çš„æ ‘çš„è¯æ˜è·¯å¾„ã€‚å®Œæ•´çš„è¯æ˜è·¯å¾„ç”±æ ‘çš„æ¯ä¸€â€œå±‚â€ä¸Šçš„ä¸€ä¸ªè¯æ˜èŠ‚ç‚¹ç»„æˆï¼Œå³æœ€å¤§æ·±åº¦ä¸º 14 æ„å‘³ç€æœ‰ 14 ä¸ªè¯æ˜èŠ‚ç‚¹ã€‚æ¯ä¸ªè¯æ˜èŠ‚ç‚¹éƒ½ä¼šåœ¨äº¤æ˜“ä¸­å¢åŠ  32 å­—èŠ‚çš„å¤§å°ï¼Œå¦‚æœä¸åœ¨é“¾ä¸Šç¼“å­˜è¯æ˜èŠ‚ç‚¹ï¼Œå¤§å‹æ ‘å¾ˆå¿«å°±ä¼šè¶…è¿‡æœ€å¤§äº¤æ˜“å¤§å°é™åˆ¶ã€‚

è¿™ä¸‰ä¸ªå€¼ï¼Œæœ€å¤§æ·±åº¦ã€æœ€å¤§ç¼“å†²åŒºå¤§å°å’Œæ—å† æ·±åº¦ï¼Œéƒ½å­˜åœ¨æƒè¡¡ã€‚å¢åŠ ä»»ä½•ä¸€ä¸ªå€¼éƒ½ä¼šå¢åŠ ç”¨äºå­˜å‚¨æ ‘çš„è´¦æˆ·çš„å¤§å°ï¼Œä»è€Œå¢åŠ åˆ›å»ºæ ‘çš„æˆæœ¬ã€‚

é€‰æ‹©æœ€å¤§æ·±åº¦ç›¸å¯¹æ¯”è¾ƒç›´æ¥ï¼Œå› ä¸ºå®ƒç›´æ¥å…³ç³»åˆ°å¶å­èŠ‚ç‚¹çš„æ•°é‡ï¼Œå› æ­¤ä¹Ÿå°±å…³ç³»åˆ°å¯ä»¥å­˜å‚¨çš„æ•°æ®é‡ã€‚å¦‚æœä½ éœ€è¦åœ¨å•ä¸ªæ ‘ä¸Šå­˜å‚¨100ä¸‡ä¸ª cNFTsï¼Œåˆ™æ‰¾åˆ°ä½¿ä»¥ä¸‹è¡¨è¾¾å¼æˆç«‹çš„æœ€å¤§æ·±åº¦ï¼š`2^maxDepth > 100ä¸‡`ã€‚ç­”æ¡ˆæ˜¯ 20ã€‚

é€‰æ‹©æœ€å¤§ç¼“å†²åŒºå¤§å°å®é™…ä¸Šæ˜¯ä¸€ä¸ªååé‡é—®é¢˜ï¼šä½ éœ€è¦å¤šå°‘å¹¶å‘å†™å…¥ã€‚

### SPL çŠ¶æ€å‹ç¼©å’Œ Noop ç¨‹åº

SPL çŠ¶æ€å‹ç¼©ç¨‹åºï¼ˆSPL State Compression Programï¼‰çš„å­˜åœ¨æ˜¯ä¸ºäº†ä½¿ä¸Šè¿°è¿‡ç¨‹åœ¨ Solana ç”Ÿæ€ç³»ç»Ÿä¸­å¯ä»¥é‡å¤å’Œç»„åˆã€‚å®ƒæä¾›äº†åˆå§‹åŒ– Merkle æ ‘ã€ç®¡ç†æ ‘å¶ï¼ˆä¾‹å¦‚æ·»åŠ ã€æ›´æ–°ã€åˆ é™¤æ•°æ®ï¼‰å’ŒéªŒè¯å¶å­æ•°æ®çš„æŒ‡ä»¤ã€‚

çŠ¶æ€å‹ç¼©ç¨‹åºè¿˜åˆ©ç”¨äº†ä¸€ä¸ªå•ç‹¬çš„â€œæ— æ“ä½œâ€ç¨‹åºï¼ˆâ€œno opâ€ programï¼‰ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯é€šè¿‡å°†æ•°æ®è®°å½•åˆ°è´¦æœ¬çŠ¶æ€ä¸­ï¼Œä½¿å¶å­æ•°æ®æ›´å®¹æ˜“è¢«ç´¢å¼•ã€‚

### ä½¿ç”¨è´¦æœ¬çŠ¶æ€è¿›è¡Œå­˜å‚¨

Solana è´¦æœ¬æ˜¯ä¸€ä¸ªåŒ…å«å·²ç­¾åäº¤æ˜“çš„æ¡ç›®åˆ—è¡¨ã€‚ç†è®ºä¸Šï¼Œè¿™å¯ä»¥è¿½æº¯åˆ°åˆ›ä¸–åŒºå—ã€‚è¿™å®é™…ä¸Šæ„å‘³ç€ä»»ä½•æ›¾ç»æ”¾å…¥äº¤æ˜“ä¸­çš„æ•°æ®éƒ½å­˜åœ¨äºè´¦æœ¬ä¸­ã€‚

å½“ä½ æƒ³è¦å­˜å‚¨å‹ç¼©æ•°æ®æ—¶ï¼Œä½ å°†å…¶ä¼ é€’ç»™çŠ¶æ€å‹ç¼©ç¨‹åºï¼Œå®ƒä¼šå¯¹å…¶è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œå¹¶ä½œä¸ºä¸€ä¸ªâ€œäº‹ä»¶ï¼ˆeventï¼‰â€å‘å‡ºåˆ°æ— æ“ä½œç¨‹åºã€‚ç„¶åï¼Œå“ˆå¸Œå€¼å­˜å‚¨åœ¨ç›¸åº”çš„å¹¶å‘ Merkle æ ‘ä¸­ã€‚ç”±äºæ•°æ®ç»è¿‡äº†äº¤æ˜“ä¼ é€’ï¼Œç”šè‡³å­˜åœ¨äºæ— æ“ä½œç¨‹åºçš„æ—¥å¿—ä¸­ï¼Œå› æ­¤å®ƒå°†æ°¸è¿œå­˜åœ¨äºè´¦æœ¬çŠ¶æ€ä¸­ã€‚

### ä¸ºäº†æ–¹ä¾¿æŸ¥æ‰¾è€Œç´¢å¼•æ•°æ®

åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œé€šå¸¸ä¼šé€šè¿‡è·å–é€‚å½“çš„è´¦æˆ·æ¥è®¿é—®é“¾ä¸Šæ•°æ®ã€‚ç„¶è€Œï¼Œå½“ä½¿ç”¨çŠ¶æ€å‹ç¼©æ—¶ï¼Œæƒ…å†µå°±ä¸é‚£ä¹ˆç®€å•äº†ã€‚

å¦‚ä¸Šæ‰€è¿°ï¼Œæ•°æ®ç°åœ¨å­˜åœ¨äºè´¦æœ¬çŠ¶æ€ä¸­ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè´¦æˆ·ä¸­ã€‚æ‰¾åˆ°å®Œæ•´æ•°æ®çš„æœ€å®¹æ˜“çš„åœ°æ–¹æ˜¯åœ¨æ— æ“ä½œæŒ‡ä»¤çš„æ—¥å¿—ä¸­ï¼Œä½†æ˜¯å°½ç®¡è¿™äº›æ•°æ®åœ¨æŸç§ç¨‹åº¦ä¸Šå°†æ°¸è¿œå­˜åœ¨äºè´¦æœ¬çŠ¶æ€ä¸­ï¼Œä½†åœ¨ä¸€æ®µæ—¶é—´åï¼Œå®ƒä»¬å¯èƒ½ä¼šåœ¨éªŒè¯èŠ‚ç‚¹ä¸­å˜å¾—æ— æ³•è®¿é—®ã€‚

ä¸ºäº†èŠ‚çœç©ºé—´å¹¶æé«˜æ€§èƒ½ï¼ŒéªŒè¯èŠ‚ç‚¹ä¸ä¼šä¿ç•™æ¯ä¸ªäº¤æ˜“ç›´åˆ°åˆ›ä¸–åŒºå—ã€‚ä½ èƒ½å¤Ÿè®¿é—®ä¸ä½ çš„æ•°æ®ç›¸å…³çš„æ— æ“ä½œæŒ‡ä»¤æ—¥å¿—çš„å…·ä½“æ—¶é—´å°†æ ¹æ®éªŒè¯èŠ‚ç‚¹è€Œå¼‚ï¼Œä½†æ˜¯å¦‚æœä½ ç›´æ¥ä¾èµ–äºæŒ‡ä»¤æ—¥å¿—ï¼Œæœ€ç»ˆä½ å°†å¤±å»å¯¹å…¶çš„è®¿é—®æƒé™ã€‚

ä»æŠ€æœ¯ä¸Šè®²ï¼Œä½ *å¯ä»¥*å°†äº¤æ˜“çŠ¶æ€å›æº¯åˆ°åˆ›ä¸–åŒºå—ï¼Œä½†æ™®é€šå›¢é˜Ÿä¸ä¼šè¿™æ ·åšï¼Œè€Œä¸”è‚¯å®šä¸ä¼šæ˜¯é«˜æ•ˆçš„ã€‚ç›¸åï¼Œä½ åº”è¯¥ä½¿ç”¨ä¸€ä¸ªç´¢å¼•å™¨ï¼Œè§‚å¯Ÿå‘é€åˆ°æ— æ“ä½œç¨‹åºçš„äº‹ä»¶ï¼Œå¹¶å°†ç›¸å…³æ•°æ®å­˜å‚¨åœ¨é“¾ä¸‹ã€‚è¿™æ ·ä½ å°±ä¸å¿…æ‹…å¿ƒæ—§æ•°æ®å˜å¾—æ— æ³•è®¿é—®ã€‚

## åˆ›å»º cNFT é›†åˆ

ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†ç†è®ºçŸ¥è¯†ï¼Œè®©æˆ‘ä»¬å°†æ³¨æ„åŠ›è½¬å‘æœ¬è¯¾ç¨‹çš„é‡ç‚¹ï¼šå¦‚ä½•åˆ›å»º cNFT é›†åˆã€‚

å¹¸è¿çš„æ˜¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ç”± Solana åŸºé‡‘ä¼šã€Solana å¼€å‘è€…ç¤¾åŒºå’Œ Metaplex åˆ›å»ºçš„å·¥å…·æ¥ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `@solana/spl-account-compression` SDKã€Metaplex Bubblegum ç¨‹åºä»¥åŠ Bubblegum ç¨‹åºçš„ç›¸åº” TS SDK `@metaplex-foundation/mpl-bugglegum`ã€‚

<aside>

ğŸ’¡ åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼ŒMetaplex å›¢é˜Ÿæ­£åœ¨è¿‡æ¸¡åˆ°ä¸€ä¸ªæ–°çš„ Bubblegum å®¢æˆ·ç«¯ SDKï¼Œè¯¥ SDK æ”¯æŒ umiï¼Œè¿™æ˜¯ä»–ä»¬ç”¨äºæ„å»ºå’Œä½¿ç”¨ Solana ç¨‹åºçš„æ¨¡å—åŒ–æ¡†æ¶ã€‚åœ¨æœ¬è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ä½¿ç”¨ SDK çš„ umi ç‰ˆæœ¬ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†æŠŠæˆ‘ä»¬çš„ä¾èµ–ç¡¬ç¼–ç åˆ°ç‰ˆæœ¬0.7ï¼ˆ`@metaplex-foundation/mpl-bubblegum@0.7`ï¼‰ã€‚è¯¥ç‰ˆæœ¬æä¾›äº†ç”¨äºæ„å»º Bubblegum æŒ‡ä»¤çš„ç®€å•è¾…åŠ©å‡½æ•°ã€‚

</aside>

### å‡†å¤‡å…ƒæ•°æ®

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ‚¨å°†å‡†å¤‡æ‚¨çš„ NFT å…ƒæ•°æ®ï¼Œç±»ä¼¼äºå¦‚æœæ‚¨ä½¿ç”¨ç³–æœæœºæ—¶æ‰€åšçš„æ–¹å¼ã€‚åœ¨æœ¬è´¨ä¸Šï¼ŒNFT åªæ˜¯ä¸€ä¸ªå¸¦æœ‰ç¬¦åˆ NFT æ ‡å‡†çš„å…ƒæ•°æ®çš„ä»£å¸ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒçš„ç»“æ„åº”è¯¥ç±»ä¼¼äºä¸‹é¢è¿™æ ·ï¼š

```json
{
  "name": "12_217_47",
  "symbol": "RGB",
  "description": "Random RGB Color",
  "seller_fee_basis_points": 0,
  "image": "https://raw.githubusercontent.com/ZYJLiu/rgb-png-generator/master/assets/12_217_47/12_217_47.png",
  "attributes": [
    {
      "trait_type": "R",
      "value": "12"
    },
    {
      "trait_type": "G",
      "value": "217"
    },
    {
      "trait_type": "B",
      "value": "47"
    }
  ]
}
```

æ ¹æ®æ‚¨çš„ç”¨ä¾‹ï¼Œæ‚¨å¯ä»¥åŠ¨æ€ç”Ÿæˆè¿™äº›æ•°æ®ï¼Œæˆ–è€…æ‚¨å¯èƒ½å¸Œæœ›æå‰ä¸ºæ¯ä¸ª cNFT å‡†å¤‡ä¸€ä¸ª JSON æ–‡ä»¶ã€‚æ‚¨è¿˜éœ€è¦ä»»ä½•å…¶ä»–åœ¨ JSON ä¸­å¼•ç”¨çš„èµ„äº§ï¼Œä¾‹å¦‚ä¸Šé¢ç¤ºä¾‹ä¸­æ˜¾ç¤ºçš„ `image` URLã€‚

### åˆ›å»ºé›†åˆ NFT

å¦‚æœæ‚¨å¸Œæœ›æ‚¨çš„ cNFTs æˆä¸ºé›†åˆçš„ä¸€éƒ¨åˆ†ï¼Œåœ¨å¼€å§‹é“¸é€  cNFTs ä¹‹å‰ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªé›†åˆ NFTã€‚è¿™æ˜¯ä¸€ä¸ªä¼ ç»Ÿçš„ NFTï¼Œä½œä¸ºå°†æ‚¨çš„ cNFTs ç»‘å®šåˆ°å•ä¸ªé›†åˆä¸­çš„å‚è€ƒã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `@metaplex-foundation/js` åº“åˆ›å»ºæ­¤ NFTã€‚åªéœ€ç¡®ä¿å°† `isCollection` è®¾ç½®ä¸º `true` å³å¯ã€‚

```tsx
const collectionNft = await metaplex.nfts().create({
    uri: someUri,
    name: "Collection NFT",
    sellerFeeBasisPoints: 0,
    updateAuthority: somePublicKey,
    mintAuthority: somePublicKey,
    tokenStandard: 0,
    symbol: "Collection",
    isMutable: true,
    isCollection: true,
})
```

### åˆ›å»º Merkle æ ‘è´¦æˆ·

ç°åœ¨æˆ‘ä»¬å¼€å§‹åç¦»åˆ›å»ºä¼ ç»Ÿ NFTs æ—¶æ‰€ä½¿ç”¨çš„æµç¨‹ã€‚æ‚¨ç”¨äºçŠ¶æ€å‹ç¼©çš„é“¾ä¸Šå­˜å‚¨æœºåˆ¶æ˜¯ä¸€ä¸ªä»£è¡¨å¹¶å‘ Merkle æ ‘çš„è´¦æˆ·ã€‚è¿™ä¸ª Merkle æ ‘è´¦æˆ·å±äº SPL çŠ¶æ€å‹ç¼©ç¨‹åºã€‚åœ¨æ‚¨æ‰§è¡Œä¸ cNFT ç›¸å…³çš„ä»»ä½•æ“ä½œä¹‹å‰ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªç©ºçš„ Merkle æ ‘è´¦æˆ·ï¼Œå…¶å¤§å°é€‚å½“ã€‚

å½±å“è´¦æˆ·å¤§å°çš„å˜é‡åŒ…æ‹¬ï¼š

1. æœ€å¤§æ·±åº¦
2. æœ€å¤§ç¼“å†²åŒºå¤§å°
3. æ—å† æ·±åº¦

ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå˜é‡å¿…é¡»ä»ç°æœ‰çš„ä¸€ç»„æœ‰æ•ˆé…å¯¹ä¸­é€‰æ‹©ã€‚ä¸‹è¡¨æ˜¾ç¤ºäº†æœ‰æ•ˆé…å¯¹ä»¥åŠè¿™äº›å€¼å¯ä»¥åˆ›å»ºçš„ cNFT çš„æ•°é‡ã€‚

| æœ€å¤§æ·±åº¦ | æœ€å¤§ç¼“å†²åŒºå¤§å° | æœ€å¤§ cNFT æ•°é‡ |
| --- | --- | --- |
| 3 | 8 | 8 |
| 5 | 8 | 32 |
| 14 | 64 | 16,384 |
| 14 | 256 | 16,384 |
| 14 | 1,024 | 16,384 |
| 14 | 2,048 | 16,384 |
| 15 | 64 | 32,768 |
| 16 | 64 | 65,536 |
| 17 | 64 | 131,072 |
| 18 | 64 | 262,144 |
| 19 | 64 | 524,288 |
| 20 | 64 | 1,048,576 |
| 20 | 256 | 1,048,576 |
| 20 | 1,024 | 1,048,576 |
| 20 | 2,048 | 1,048,576 |
| 24 | 64 | 16,777,216 |
| 24 | 256 | 16,777,216 |
| 24 | 512 | 16,777,216 |
| 24 | 1,024 | 16,777,216 |
| 24 | 2,048 | 16,777,216 |
| 26 | 512 | 67,108,864 |
| 26 | 1,024 | 67,108,864 |
| 26 | 2,048 | 67,108,864 |
| 30 | 512 | 1,073,741,824 |
| 30 | 1,024 | 1,073,741,824 |
| 30 | 2,048 | 1,073,741,824 |

è¯·æ³¨æ„ï¼Œå¯ä»¥å­˜å‚¨åœ¨æ ‘ä¸Šçš„ cNFT çš„æ•°é‡å®Œå…¨å–å†³äºæœ€å¤§æ·±åº¦ï¼Œè€Œç¼“å†²åŒºå¤§å°å°†ç¡®å®šåœ¨åŒä¸€æ—¶é—´æ®µå†…å¯¹æ ‘è¿›è¡Œçš„å¹¶å‘æ›´æ”¹ï¼ˆé“¸é€ ã€è½¬ç§»ç­‰ï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œé€‰æ‹©ä¸æ‚¨éœ€è¦æ ‘ä¿å­˜çš„ NFT æ•°é‡ç›¸å¯¹åº”çš„æœ€å¤§æ·±åº¦ï¼Œç„¶åæ ¹æ®æ‚¨é¢„è®¡éœ€è¦æ”¯æŒçš„æµé‡ï¼Œé€‰æ‹©ç¼“å†²åŒºå¤§å°çš„å…¶ä¸­é€‰é¡¹ä¹‹ä¸€ã€‚

æ¥ä¸‹æ¥ï¼Œé€‰æ‹©æ ‘å† æ·±åº¦ã€‚å¢åŠ æ ‘å† æ·±åº¦ä¼šå¢åŠ æ‚¨çš„ cNFT çš„å¯ç»„åˆæ€§ã€‚åœ¨æœªæ¥ï¼Œæ¯å½“æ‚¨æˆ–å…¶ä»–å¼€å‘äººå‘˜çš„ä»£ç å°è¯•éªŒè¯ cNFT æ—¶ï¼Œä»£ç å°†ä¸å¾—ä¸ä¼ é€’ä¸æ ‘ä¸­â€œå±‚â€ä¸€æ ·å¤šçš„è¯æ˜èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œå¯¹äºæœ€å¤§æ·±åº¦ä¸º 20ï¼Œæ‚¨éœ€è¦ä¼ é€’ 20 ä¸ªè¯æ˜èŠ‚ç‚¹ã€‚è¿™ä¸ä»…å¾ˆç¹çï¼Œè€Œä¸”ç”±äºæ¯ä¸ªè¯æ˜èŠ‚ç‚¹éƒ½æ˜¯ 32 å­—èŠ‚ï¼Œå¾ˆå®¹æ˜“è¿…é€Ÿè¾¾åˆ°äº¤æ˜“å¤§å°çš„ä¸Šé™ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ çš„æ ‘çš„æ ‘å† æ·±åº¦å¾ˆä½ï¼Œä¸€ä¸ª NFT å¸‚åœºå¯èƒ½åªèƒ½æ”¯æŒç®€å•çš„ NFT è½¬ç§»ï¼Œè€Œæ— æ³•æ”¯æŒä½ çš„ cNFT çš„é“¾ä¸Šç«æ ‡ç³»ç»Ÿã€‚æ ‘å† æœ‰æ•ˆåœ°å°†è¯æ˜èŠ‚ç‚¹ç¼“å­˜åœ¨é“¾ä¸Šï¼Œè¿™æ ·ä½ å°±ä¸å¿…å°†å®ƒä»¬å…¨éƒ¨ä¼ é€’åˆ°äº¤æ˜“ä¸­ï¼Œä»è€Œå…è®¸æ›´å¤æ‚çš„äº¤æ˜“ã€‚

å¢åŠ è¿™ä¸‰ä¸ªå€¼ä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½ä¼šå¢åŠ è´¦æˆ·çš„å¤§å°ï¼Œä»è€Œå¢åŠ åˆ›å»ºè´¦æˆ·çš„ç›¸å…³æˆæœ¬ã€‚åœ¨é€‰æ‹©è¿™äº›å€¼æ—¶ï¼Œè¯·æ ¹æ®åˆ©å¼Šæƒè¡¡ã€‚

ä¸€æ—¦ä½ çŸ¥é“äº†è¿™äº›å€¼ï¼Œä½ å¯ä»¥ä½¿ç”¨ `@solana/spl-account-compression` TypeScript SDK ä¸­çš„ `createAllocTreeIx` è¾…åŠ©å‡½æ•°æ¥åˆ›å»ºç©ºè´¦æˆ·çš„æŒ‡ä»¤ã€‚

```tsx
import { createAllocTreeIx } from "@solana/spl-account-compression"

const treeKeypair = Keypair.generate()

const allocTreeIx = await createAllocTreeIx(
  connection,
  treeKeypair.publicKey,
  payer.publicKey,
  { maxDepth: 20; maxBufferSize: 256 },
  canopyDepth
)
```

è¯·æ³¨æ„ï¼Œè¿™ä»…ä»…æ˜¯ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºè®¡ç®—è´¦æˆ·æ‰€éœ€çš„å¤§å°å¹¶åˆ›å»ºå‘é€ç»™ç³»ç»Ÿç¨‹åºä»¥åˆ†é…è´¦æˆ·çš„æŒ‡ä»¤ã€‚è¿™ä¸ªå‡½æ•°ç›®å‰è¿˜æ²¡æœ‰ä¸ä»»ä½•ç‰¹å®šäºå‹ç¼©çš„ç¨‹åºäº¤äº’ã€‚

### ä½¿ç”¨ Bubblegum åˆå§‹åŒ–æ‚¨çš„æ ‘

åˆ›å»ºäº†ç©ºçš„æ ‘è´¦æˆ·ä¹‹åï¼Œæ¥ä¸‹æ¥æ‚¨å¯ä»¥ä½¿ç”¨ Bubblegum ç¨‹åºæ¥åˆå§‹åŒ–æ ‘ã€‚é™¤äº† Merkle æ ‘è´¦æˆ·ä¹‹å¤–ï¼ŒBubblegum è¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ ‘é…ç½®è´¦æˆ·ï¼Œç”¨äºæ·»åŠ  cNFT ç‰¹å®šçš„è·Ÿè¸ªå’ŒåŠŸèƒ½ã€‚

`@metaplex-foundation/mpl-bubblegum` TypeScript SDK çš„ 0.7 ç‰ˆæœ¬æä¾›äº†ä¸€ä¸ªè¾…åŠ©å‡½æ•° `createCreateTreeInstruction`ï¼Œç”¨äºè°ƒç”¨ Bubblegum ç¨‹åºä¸Šçš„ `create_tree` æŒ‡ä»¤ã€‚ä½œä¸ºè°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼Œæ‚¨éœ€è¦æ´¾ç”Ÿç¨‹åºæ‰€æœŸæœ›çš„ `treeAuthority` PDAã€‚è¿™ä¸ª PDA ä½¿ç”¨æ ‘çš„åœ°å€ä½œä¸ºç§å­ã€‚

```tsx
import {
	createAllocTreeIx,
	SPL_ACCOUNT_COMPRESSION_PROGRAM_ID,
  SPL_NOOP_PROGRAM_ID,
} from "@solana/spl-account-compression"
import {
  PROGRAM_ID as BUBBLEGUM_PROGRAM_ID,
  createCreateTreeInstruction,
} from "@metaplex-foundation/mpl-bubblegum"

...

const [treeAuthority, _bump] = PublicKey.findProgramAddressSync(
  [treeKeypair.publicKey.toBuffer()],
  BUBBLEGUM_PROGRAM_ID
)

const createTreeIx = createCreateTreeInstruction(
  {
    treeAuthority,
    merkleTree: treeKeypair.publicKey,
    payer: payer.publicKey,
    treeCreator: payer.publicKey,
    logWrapper: SPL_NOOP_PROGRAM_ID,
    compressionProgram: SPL_ACCOUNT_COMPRESSION_PROGRAM_ID,
  },
  {
    maxBufferSize: 256,
    maxDepth: 20,
    public: false,
  },
  BUBBLEGUM_PROGRAM_ID
)
```

ä¸‹é¢åˆ—å‡ºäº†è¿™ä¸ªè¾…åŠ©å‡½æ•°æ‰€éœ€çš„è¾“å…¥ï¼š

- `accounts` - ä¸€ä¸ªè¡¨ç¤ºæŒ‡ä»¤æ‰€éœ€è´¦æˆ·çš„å¯¹è±¡ã€‚åŒ…æ‹¬ï¼š
    - `treeAuthority` - Bubblegum æœŸæœ›è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Merkle æ ‘åœ°å€ä½œä¸ºç§å­æ´¾ç”Ÿå‡ºçš„ PDAã€‚
    - `merkleTree` - Merkle æ ‘è´¦æˆ·ã€‚
    - `payer` - æ”¯ä»˜äº¤æ˜“è´¹ç”¨ã€ç§Ÿé‡‘ç­‰çš„åœ°å€ã€‚
    - `treeCreator` - åˆ—ä¸ºæ ‘åˆ›å»ºè€…çš„åœ°å€ã€‚
    - `logWrapper` - ç”¨äºé€šè¿‡æ—¥å¿—å‘ç´¢å¼•å™¨å…¬å¼€æ•°æ®çš„ç¨‹åºï¼›é™¤éæ‚¨æœ‰å…¶ä»–è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™åº”è¯¥æ˜¯ SPL Noop ç¨‹åºçš„åœ°å€ã€‚
    - `compressionProgram` - ç”¨äºåˆå§‹åŒ– Merkle æ ‘çš„å‹ç¼©ç¨‹åºï¼›é™¤éæ‚¨æœ‰å…¶ä»–è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™åº”è¯¥æ˜¯ SPL State Compression ç¨‹åºçš„åœ°å€ã€‚
- `args` - è¡¨ç¤ºæŒ‡ä»¤æ‰€éœ€çš„é¢å¤–å‚æ•°çš„å¯¹è±¡ã€‚åŒ…æ‹¬ï¼š
    - `maxBufferSize` - Merkle æ ‘çš„æœ€å¤§ç¼“å†²åŒºå¤§å°ã€‚
    - `maxDepth` - Merkle æ ‘çš„æœ€å¤§æ·±åº¦ã€‚
    - `public` - å½“è®¾ç½®ä¸º `true` æ—¶ï¼Œä»»ä½•äººéƒ½å¯ä»¥ä»æ ‘ä¸­é“¸é€  cNFTï¼›å½“è®¾ç½®ä¸º `false` æ—¶ï¼Œåªæœ‰æ ‘åˆ›å»ºè€…æˆ–æ ‘å§”æ‰˜è€…å¯ä»¥ä»æ ‘ä¸­é“¸é€  cNFTã€‚

æäº¤åï¼Œè¿™å°†è°ƒç”¨ Bubblegum ç¨‹åºä¸Šçš„ `create_tree` æŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤æ‰§è¡Œä¸‰ä¸ªæ“ä½œï¼š

1. åˆ›å»ºæ ‘é…ç½® PDA è´¦æˆ·ã€‚
2. ä½¿ç”¨é€‚å½“çš„åˆå§‹å€¼åˆå§‹åŒ–æ ‘é…ç½®è´¦æˆ·ã€‚
3. å‘ State Compression ç¨‹åºå‘å‡º CPIï¼Œä»¥åˆå§‹åŒ–ç©ºçš„ Merkle æ ‘è´¦æˆ·ã€‚

æ¬¢è¿æŸ¥çœ‹ Bubblegum ç¨‹åºä»£ç [è¿™é‡Œ](https://github.com/metaplex-foundation/mpl-bubblegum/blob/main/programs/bubblegum/program/src/lib.rs#L887)ã€‚

### é“¸é€  cNFTs

æœ‰äº†åˆå§‹åŒ–çš„ Merkle æ ‘è´¦æˆ·åŠå…¶å¯¹åº”çš„ Bubblegum æ ‘é…ç½®è´¦æˆ·ï¼Œå°±å¯ä»¥å‘æ ‘ä¸­é“¸é€  cNFTsã€‚è¦ä½¿ç”¨çš„ Bubblegum æŒ‡ä»¤å°†æ˜¯ `mint_v1` æˆ– `mint_to_collection_v1`ï¼Œå…·ä½“å–å†³äºæ‚¨æ˜¯å¦å¸Œæœ›é“¸é€ çš„ cNFT æˆä¸ºé›†åˆçš„ä¸€éƒ¨åˆ†ã€‚

`@metaplex-foundation/mpl-bubblegum` TypeScript SDK çš„ 0.7 ç‰ˆæœ¬æä¾›äº†è¾…åŠ©å‡½æ•° `createMintV1Instruction` å’Œ `createMintToCollectionV1Instruction`ï¼Œä»¥ä¾¿æ‚¨æ›´è½»æ¾åœ°åˆ›å»ºæŒ‡ä»¤ã€‚

è¿™ä¸¤ä¸ªå‡½æ•°éƒ½éœ€è¦æ‚¨ä¼ é€’ NFT å…ƒæ•°æ®å’Œç”¨äºé“¸é€  cNFT æ‰€éœ€çš„è´¦æˆ·åˆ—è¡¨ã€‚ä»¥ä¸‹æ˜¯å‘é›†åˆä¸­é“¸é€ çš„ç¤ºä¾‹ï¼š

```tsx
const mintWithCollectionIx = createMintToCollectionV1Instruction(
  {
    payer: payer.publicKey,
    merkleTree: treeAddress,
    treeAuthority,
    treeDelegate: payer.publicKey,
    leafOwner: destination,
    leafDelegate: destination,
    collectionAuthority: payer.publicKey,
    collectionAuthorityRecordPda: BUBBLEGUM_PROGRAM_ID,
    collectionMint: collectionDetails.mint,
    collectionMetadata: collectionDetails.metadata,
    editionAccount: collectionDetails.masterEditionAccount,
    compressionProgram: SPL_ACCOUNT_COMPRESSION_PROGRAM_ID,
    logWrapper: SPL_NOOP_PROGRAM_ID,
    bubblegumSigner,
    tokenMetadataProgram: TOKEN_METADATA_PROGRAM_ID,
  },
  {
    metadataArgs: Object.assign(nftMetadata, {
      collection: { key: collectionDetails.mint, verified: false },
    }),
  }
)
```

è¯·æ³¨æ„ï¼Œè¾…åŠ©å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼š`accounts` å’Œ `args`ã€‚`args` å‚æ•°åªæ˜¯ NFT å…ƒæ•°æ®ï¼Œè€Œ `accounts` åˆ™æ˜¯åˆ—å‡ºæŒ‡ä»¤æ‰€éœ€çš„è´¦æˆ·çš„å¯¹è±¡ã€‚è¯šç„¶ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šï¼š

- `payer` - æ”¯ä»˜äº¤æ˜“è´¹ç”¨ã€ç§Ÿé‡‘ç­‰çš„è´¦æˆ·ã€‚
- `merkleTree` - Merkle æ ‘è´¦æˆ·ã€‚
- `treeAuthority` - æ ‘çš„æˆæƒè´¦æˆ·ï¼›åº”è¯¥ä¸ä¹‹å‰æ´¾ç”Ÿçš„ PDA ç›¸åŒã€‚
- `treeDelegate` - æ ‘çš„å§”æ‰˜è´¦æˆ·ï¼›é€šå¸¸ä¸æ ‘åˆ›å»ºè€…ç›¸åŒã€‚
- `leafOwner` - æ­£åœ¨é“¸é€ çš„å‹ç¼© NFT çš„æœŸæœ›æ‰€æœ‰è€…ã€‚
- `leafDelegate` - æ­£åœ¨é“¸é€ çš„å‹ç¼© NFT çš„æœŸæœ›å§”æ‰˜è€…ï¼›é€šå¸¸ä¸å¶æ‰€æœ‰è€…ç›¸åŒã€‚
- `collectionAuthority` - é›†åˆ NFT çš„æˆæƒè´¦æˆ·ã€‚
- `collectionAuthorityRecordPda` - å¯é€‰çš„é›†åˆæˆæƒè®°å½• PDAï¼›é€šå¸¸æ²¡æœ‰ï¼Œæ­¤æ—¶åº”å°† Bubblegum ç¨‹åºåœ°å€æ”¾åœ¨è¿™é‡Œã€‚
- `collectionMint` - é›†åˆ NFT çš„é“¸å¸è´¦æˆ·ã€‚
- `collectionMetadata` - é›†åˆ NFT çš„å…ƒæ•°æ®è´¦æˆ·ã€‚
- `editionAccount` - é›†åˆ NFT çš„ä¸»ç‰ˆæœ¬è´¦æˆ·ã€‚
- `compressionProgram` - è¦ä½¿ç”¨çš„å‹ç¼©ç¨‹åºï¼›é™¤éæœ‰å…¶ä»–è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™åº”è¯¥æ˜¯ SPL State Compression ç¨‹åºçš„åœ°å€ã€‚
- `logWrapper` - ç”¨äºé€šè¿‡æ—¥å¿—å‘ç´¢å¼•å™¨å…¬å¼€æ•°æ®çš„ç¨‹åºï¼›é™¤éæœ‰å…¶ä»–è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™åº”è¯¥æ˜¯ SPL Noop ç¨‹åºçš„åœ°å€ã€‚
- `bubblegumSigner` - Bubblegrum ç¨‹åºç”¨äºå¤„ç†é›†åˆéªŒè¯çš„ PDAã€‚
- `tokenMetadataProgram` - ç”¨äºé›†åˆ NFT çš„ä»£å¸å…ƒæ•°æ®ç¨‹åºï¼›é€šå¸¸å§‹ç»ˆæ˜¯ Metaplex ä»¤ç‰Œå…ƒæ•°æ®ç¨‹åºã€‚

å¦‚æœä¸ä½¿ç”¨é›†åˆè¿›è¡Œé“¸é€ ï¼Œåˆ™æ‰€éœ€çš„è´¦æˆ·è¾ƒå°‘ï¼Œå…¶ä¸­æ²¡æœ‰ä¸€ä¸ªæ˜¯ä¸“é—¨ç”¨äºä¸ä½¿ç”¨é›†åˆè¿›è¡Œé“¸é€ çš„ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹ã€‚

```tsx
const mintWithoutCollectionIx = createMintV1Instruction(
  {
    payer: payer.publicKey,
    merkleTree: treeAddress,
    treeAuthority,
    treeDelegate: payer.publicKey,
    leafOwner: destination,
    leafDelegate: destination,
    compressionProgram: SPL_ACCOUNT_COMPRESSION_PROGRAM_ID,
    logWrapper: SPL_NOOP_PROGRAM_ID,
  },
  {
    message: nftMetadata,
  }
)
```

## ä¸ cNFTs äº¤äº’

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒcNFTs *ä¸æ˜¯* SPL ä»£å¸ã€‚è¿™æ„å‘³ç€æ‚¨çš„ä»£ç éœ€è¦éµå¾ªä¸åŒçš„çº¦å®šï¼Œä»¥å¤„ç† cNFT çš„åŠŸèƒ½ï¼Œå¦‚è·å–ã€æŸ¥è¯¢ã€è½¬ç§»ç­‰ã€‚

### è·å– cNFT æ•°æ®

ä»ç°æœ‰çš„ cNFT è·å–æ•°æ®çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ [Digital Asset Standard Read API](https://docs.solana.com/developing/guides/compressed-nfts#reading-compressed-nfts-metadata)ï¼ˆè¯»å– APIï¼‰ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸æ ‡å‡†çš„ JSON RPC æ˜¯åˆ†å¼€çš„ã€‚è¦ä½¿ç”¨è¯»å– APIï¼Œæ‚¨éœ€è¦ä½¿ç”¨æ”¯æŒçš„ RPC æä¾›å•†ã€‚Metaplex ç»´æŠ¤äº†ä¸€ä¸ªï¼ˆå¯èƒ½ä¸å®Œæ•´çš„ï¼‰[RPC æä¾›å•†åˆ—è¡¨](https://developers.metaplex.com/bubblegum/rpcs)ï¼Œæ”¯æŒè¯»å– APIã€‚åœ¨æœ¬è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [Helius](https://docs.helius.dev/compression-and-das-api/digital-asset-standard-das-api)ï¼Œå› ä¸ºä»–ä»¬å…è´¹æ”¯æŒ Devnetã€‚

è¦ä½¿ç”¨è¯»å– API è·å–ç‰¹å®šçš„ cNFTï¼Œæ‚¨éœ€è¦æ‹¥æœ‰è¯¥ cNFT çš„èµ„äº§ IDã€‚ç„¶è€Œï¼Œåœ¨é“¸é€  cNFTs åï¼Œæ‚¨æœ€å¤šåªä¼šæœ‰ä¸¤ä¸ªä¿¡æ¯ï¼š

1. äº¤æ˜“ç­¾å
2. å¶å­ç´¢å¼•ï¼ˆå¯èƒ½ï¼‰

å”¯ä¸€çš„çœŸæ­£ä¿è¯æ˜¯æ‚¨å°†æ‹¥æœ‰äº¤æ˜“ç­¾åã€‚**å¯èƒ½**ä»ä¸­å®šä½å¶å­ç´¢å¼•ï¼Œä½†è¿™æ¶‰åŠåˆ°ä¸€äº›ç›¸å½“å¤æ‚çš„è§£æã€‚ç®€è€Œè¨€ä¹‹ï¼Œæ‚¨å¿…é¡»ä» Noop ç¨‹åºä¸­æ£€ç´¢ç›¸å…³çš„æŒ‡ä»¤æ—¥å¿—ï¼Œå¹¶è§£æå®ƒä»¬ä»¥æ‰¾åˆ°å¶å­ç´¢å¼•ã€‚æˆ‘ä»¬å°†åœ¨ä»¥åçš„è¯¾ç¨‹ä¸­æ›´æ·±å…¥åœ°è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å‡è®¾æ‚¨çŸ¥é“å¶å­ç´¢å¼•ã€‚

å¯¹äºå¤§å¤šæ•°é“¸é€ æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆç†çš„å‡è®¾ï¼Œå› ä¸ºé“¸é€ å°†ç”±æ‚¨çš„ä»£ç æ§åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥æŒ‰é¡ºåºè®¾ç½®ï¼Œä»¥ä¾¿æ‚¨çš„ä»£ç å¯ä»¥è·Ÿè¸ªæ¯ä¸ªé“¸é€ å°†ä½¿ç”¨çš„ç´¢å¼•ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ªé“¸é€ å°†ä½¿ç”¨ç´¢å¼• 0ï¼Œç¬¬äºŒä¸ªç´¢å¼• 1ï¼Œä¾æ­¤ç±»æ¨ã€‚

ä¸€æ—¦æ‚¨æœ‰äº†å¶å­ç´¢å¼•ï¼Œå°±å¯ä»¥æ´¾ç”Ÿå‡ºç›¸åº”çš„ cNFT èµ„äº§ IDã€‚åœ¨ä½¿ç”¨ Bubblegum æ—¶ï¼Œèµ„äº§ ID æ˜¯ä½¿ç”¨ Bubblegum ç¨‹åº ID å’Œä»¥ä¸‹ç§å­æ´¾ç”Ÿå‡ºæ¥çš„ï¼š

1. é™æ€å­—ç¬¦ä¸² `asset`ï¼Œä»¥ utf8 ç¼–ç è¡¨ç¤º
2. Merkle æ ‘åœ°å€
3. å¶å­ç´¢å¼•

ç´¢å¼•å™¨åŸºæœ¬ä¸Šè§‚å¯Ÿ Noop ç¨‹åºçš„äº¤æ˜“æ—¥å¿—ï¼Œå½“ Noop ç¨‹åºåœ¨ Merkle æ ‘å‘ç”Ÿå­˜å‚¨ç»è¿‡å“ˆå¸Œçš„ cNFT å…ƒæ•°æ®ã€‚è¿™ä½¿ä»–ä»¬èƒ½å¤Ÿåœ¨å“åº”è¯·æ±‚æ—¶æä¾›è¯¥æ•°æ®ã€‚è¿™ä¸ªèµ„äº§ ID æ˜¯ç´¢å¼•å™¨ç”¨æ¥æ ‡è¯†ç‰¹å®šèµ„äº§çš„ã€‚

ä¸ºäº†ç®€å•èµ·è§ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ Bubblegum SDK ä¸­çš„ `getLeafAssetId` è¾…åŠ©å‡½æ•°ã€‚æœ‰äº†èµ„äº§ IDï¼Œè·å– cNFT å°±ç›¸å½“ç®€å•äº†ã€‚åªéœ€ä½¿ç”¨æ”¯æŒçš„ RPC æä¾›ç¨‹åºæä¾›çš„ `getAsset` æ–¹æ³•ï¼š

```tsx
const assetId = await getLeafAssetId(treeAddress, new BN(leafIndex))
const response = await fetch(process.env.RPC_URL, {
	method: "POST",
	headers: { "Content-Type": "application/json" },
	body: JSON.stringify({
		jsonrpc: "2.0",
		id: "my-id",
		method: "getAsset",
		params: {
			id: assetId,
		},
	}),
})

const { result } = await response.json()
console.log(JSON.stringify(result, null, 2))
```

è¿™å°†è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ä¼ ç»Ÿ NFT çš„é“¾ä¸Šå’Œé“¾ä¸‹å…ƒæ•°æ®çš„ç»¼åˆä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨ `content.metadata.attributes` æ‰¾åˆ° cNFT çš„å±æ€§ï¼Œæˆ–è€…åœ¨ `content.files.uri` æ‰¾åˆ°å›¾åƒã€‚

### æŸ¥è¯¢ cNFTs

è¯»å– API è¿˜åŒ…æ‹¬è·å–å¤šä¸ªèµ„äº§ã€æŒ‰æ‰€æœ‰è€…ã€åˆ›å»ºè€…ç­‰æŸ¥è¯¢çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼ŒHelius æ”¯æŒä»¥ä¸‹æ–¹æ³•ï¼š

- `getAsset`
- `getSignaturesForAsset`
- `searchAssets`
- `getAssetProof`
- `getAssetsByOwner`
- `getAssetsByAuthority`
- `getAssetsByCreator`
- `getAssetsByGroup`

æˆ‘ä»¬ä¸ä¼šç›´æ¥è®¨è®ºå…¶ä¸­çš„å¤§éƒ¨åˆ†å†…å®¹ï¼Œä½†ä¸€å®šè¦ä»”ç»†é˜…è¯» [Helius æ–‡æ¡£](https://docs.helius.dev/compression-and-das-api/digital-asset-standard-das-api)ï¼Œä»¥äº†è§£å¦‚ä½•æ­£ç¡®ä½¿ç”¨å®ƒä»¬ã€‚

### è½¬ç§» cNFTs

ä¸æ ‡å‡†çš„ SPL ä»£å¸è½¬ç§»ä¸€æ ·ï¼Œå®‰å…¨æ€§æ˜¯è‡³å…³é‡è¦çš„ã€‚ç„¶è€Œï¼ŒSPL ä»£å¸è½¬ç§»ä½¿éªŒè¯è½¬ç§»æˆæƒå˜å¾—éå¸¸å®¹æ˜“ã€‚å®ƒå·²å†…ç½®äº SPL ä»£å¸ç¨‹åºå’Œæ ‡å‡†ç­¾åä¸­ã€‚å‹ç¼©ä»£å¸çš„æ‰€æœ‰æƒéªŒè¯æ›´åŠ å›°éš¾ã€‚å®é™…çš„éªŒè¯å°†åœ¨ç¨‹åºç«¯è¿›è¡Œï¼Œä½†æ‚¨çš„å®¢æˆ·ç«¯ä»£ç éœ€è¦æä¾›é¢å¤–çš„ä¿¡æ¯ä»¥ä½¿å…¶æˆä¸ºå¯èƒ½ã€‚

è™½ç„¶ Bubblegum æä¾›äº† `createTransferInstruction` è¾…åŠ©å‡½æ•°ï¼Œä½†ä¸é€šå¸¸æƒ…å†µä¸‹ç›¸æ¯”ï¼Œéœ€è¦è¿›è¡Œæ›´å¤šçš„ç»„è£…ã€‚å…·ä½“æ¥è¯´ï¼ŒBubblegum ç¨‹åºéœ€è¦éªŒè¯å®¢æˆ·ç«¯æ–­è¨€çš„æ•´ä¸ª cNFT æ•°æ®æ˜¯å¦æ­£ç¡®ï¼Œç„¶åæ‰èƒ½è¿›è¡Œè½¬ç§»ã€‚æ•´ä¸ª cNFT æ•°æ®å·²ç»è¢«å“ˆå¸Œå¹¶å­˜å‚¨ä¸º Merkle æ ‘ä¸Šçš„å•ä¸ªå¶å­ï¼Œè€Œ Merkle æ ‘åªæ˜¯æ‰€æœ‰å¶å­å’Œåˆ†æ”¯çš„å“ˆå¸Œã€‚å› æ­¤ï¼Œæ‚¨ä¸èƒ½ç®€å•åœ°å‘Šè¯‰ç¨‹åºè¦æŸ¥çœ‹å“ªä¸ªè´¦æˆ·ï¼Œå¹¶å°†è¯¥è´¦æˆ·çš„ `authority` æˆ– `owner` å­—æ®µä¸äº¤æ˜“ç­¾åè€…è¿›è¡Œæ¯”è¾ƒã€‚

ç›¸åï¼Œæ‚¨éœ€è¦æä¾›æ•´ä¸ª cNFT æ•°æ®ä»¥åŠåœ¨æ ‘å† ä¸­æœªå­˜å‚¨çš„ä»»ä½• Merkle æ ‘çš„è¯æ˜ä¿¡æ¯ã€‚è¿™æ ·ï¼Œç¨‹åºå¯ä»¥ç‹¬ç«‹è¯æ˜æ‰€æä¾›çš„ cNFT æ•°æ®ï¼Œå› æ­¤ cNFT çš„æ‰€æœ‰è€…æ˜¯å‡†ç¡®çš„ã€‚åªæœ‰åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¨‹åºæ‰èƒ½å®‰å…¨åœ°ç¡®å®šæ˜¯å¦åº”è¯¥å…è®¸äº¤æ˜“ç­¾åè€…è½¬ç§» cNFTã€‚

åœ¨å¹¿ä¹‰ä¸Šï¼Œè¿™æ¶‰åŠåˆ°ä¸€ä¸ªäº”ä¸ªæ­¥éª¤çš„è¿‡ç¨‹ï¼š

1. ä»ç´¢å¼•å™¨è·å– cNFT çš„èµ„äº§æ•°æ®
2. ä»ç´¢å¼•å™¨è·å– cNFT çš„è¯æ˜
3. ä» Solana åŒºå—é“¾è·å– Merkle æ ‘è´¦æˆ·
4. å‡†å¤‡èµ„äº§è¯æ˜ä½œä¸º `AccountMeta` å¯¹è±¡çš„åˆ—è¡¨
5. æ„å»ºå¹¶å‘é€ Bubblegum è½¬ç§»æŒ‡ä»¤

å‰ä¸¤ä¸ªæ­¥éª¤éå¸¸ç›¸ä¼¼ã€‚ä½¿ç”¨æ‚¨çš„æ”¯æŒ RPC æä¾›å•†ï¼Œåˆ†åˆ«ä½¿ç”¨ `getAsset` å’Œ `getAssetProof` æ–¹æ³•æ¥è·å–èµ„äº§æ•°æ®å’Œè¯æ˜ã€‚

```tsx
const assetDataResponse = await fetch(process.env.RPC_URL, {
	method: "POST",
	headers: { "Content-Type": "application/json" },
	body: JSON.stringify({
		jsonrpc: "2.0",
		id: "my-id",
		method: "getAsset",
			params: {
				id: assetId,
			},
		}),
	})
const assetData = (await assetDataResponse.json()).result

const assetProofResponse = await fetch(process.env.RPC_URL, {
	method: "POST",
	headers: { "Content-Type": "application/json" },
	body: JSON.stringify({
		jsonrpc: "2.0",
		id: "my-id",
		method: "getAssetProof",
			params: {
				id: assetId,
			},
		}),
	})
const assetProof = (await assetProofResponse.json()).result
```

ç¬¬ä¸‰æ­¥æ˜¯è·å– Merkle æ ‘è´¦æˆ·ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ `@solana/spl-account-compression` ä¸­çš„ `ConcurrentMerkleTreeAccount` ç±»å‹ï¼š

```tsx
const treePublicKey = new PublicKey(assetData.compression.tree)

const treeAccount = await ConcurrentMerkleTreeAccount.fromAccountAddress(
	connection,
	treePublicKey
)
```

ç¬¬å››æ­¥æ˜¯æœ€å…·æ¦‚å¿µæ€§æŒ‘æˆ˜çš„æ­¥éª¤ã€‚åˆ©ç”¨æ”¶é›†åˆ°çš„ä¸‰ä¸ªä¿¡æ¯ï¼Œæ‚¨éœ€è¦ç»„è£… cNFT å¯¹åº”å¶å­çš„è¯æ˜è·¯å¾„ã€‚è¯æ˜è·¯å¾„è¢«è¡¨ç¤ºä¸ºä¼ é€’ç»™ç¨‹åºæŒ‡ä»¤çš„è´¦æˆ·ã€‚ç¨‹åºä½¿ç”¨æ¯ä¸ªè´¦æˆ·åœ°å€ä½œä¸ºè¯æ˜èŠ‚ç‚¹ï¼Œä»¥è¯æ˜å¶å­æ•°æ®ä¸æ‚¨æ‰€è¯´çš„ä¸€è‡´ã€‚

ç´¢å¼•å™¨æä¾›äº†å®Œæ•´çš„è¯æ˜ï¼Œå°±åƒä¸Šé¢çš„ `assetProof` ä¸­æ‰€ç¤ºã€‚ç„¶è€Œï¼Œæ‚¨å¯ä»¥ä»è¯æ˜ä¸­æ’é™¤ä¸æ ‘å† æ·±åº¦ç›¸åŒæ•°é‡çš„å°¾éƒ¨è´¦æˆ·ã€‚

```tsx
const canopyDepth = treeAccount.getCanopyDepth() || 0

const proofPath: AccountMeta[] = assetProof.proof
	.map((node: string) => ({
	pubkey: new PublicKey(node),
	isSigner: false,
	isWritable: false
}))
.slice(0, assetProof.proof.length - canopyDepth)
```

æœ€åï¼Œæ‚¨å¯ä»¥ç»„è£…è½¬ç§»æŒ‡ä»¤ã€‚æŒ‡ä»¤è¾…åŠ©å‡½æ•° `createTransferInstruction` éœ€è¦ä»¥ä¸‹å‚æ•°ï¼š

ä»¥ä¸‹æ˜¯æŒ‡ä»¤è¾…åŠ©å‡½æ•° `createTransferInstruction` éœ€è¦çš„å‚æ•°ï¼š

- `accounts` - é¢„æœŸçš„æŒ‡ä»¤è´¦æˆ·åˆ—è¡¨ï¼›å®ƒä»¬å¦‚ä¸‹æ‰€ç¤ºï¼š
    - `merkleTree` - Merkle æ ‘è´¦æˆ·
    - `treeAuthority` - Merkle æ ‘çš„æˆæƒè´¦æˆ·
    - `leafOwner` - é—®é¢˜å¶å­ï¼ˆcNFTï¼‰çš„æ‰€æœ‰è€…
    - `leafDelegate` - é—®é¢˜å¶å­ï¼ˆcNFTï¼‰çš„å§”æ‰˜è€…ï¼›å¦‚æœæ²¡æœ‰æ·»åŠ å§”æ‰˜è€…ï¼Œåˆ™åº”ä¸ `leafOwner` ç›¸åŒ
    - `newLeafOwner` - è½¬ç§»åçš„æ–°æ‰€æœ‰è€…çš„åœ°å€
    - `logWrapper` - ç”¨äºé€šè¿‡æ—¥å¿—å‘ç´¢å¼•å™¨å…¬å¼€æ•°æ®çš„ç¨‹åºï¼›é™¤éæœ‰å…¶ä»–è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™åº”è¯¥æ˜¯ SPL Noop ç¨‹åºçš„åœ°å€
    - `compressionProgram` - è¦ä½¿ç”¨çš„å‹ç¼©ç¨‹åºï¼›é™¤éæœ‰å…¶ä»–è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™åº”è¯¥æ˜¯ SPL State Compression ç¨‹åºçš„åœ°å€
    - `anchorRemainingAccounts` - è¿™æ˜¯æ‚¨æ·»åŠ è¯æ˜è·¯å¾„çš„åœ°æ–¹
- `args` - æŒ‡ä»¤æ‰€éœ€çš„é¢å¤–å‚æ•°ï¼›å®ƒä»¬æ˜¯ï¼š
    - `root` - ä»èµ„äº§è¯æ˜ä¸­æå–çš„ Merkle æ ‘æ ¹èŠ‚ç‚¹ï¼›è¿™æ˜¯ç”±ç´¢å¼•å™¨æä¾›çš„å­—ç¬¦ä¸²ï¼Œå¿…é¡»å…ˆè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
    - `dataHash` - ä»ç´¢å¼•å™¨æ£€ç´¢çš„èµ„äº§æ•°æ®çš„å“ˆå¸Œï¼›è¿™æ˜¯ç”±ç´¢å¼•å™¨æä¾›çš„å­—ç¬¦ä¸²ï¼Œå¿…é¡»å…ˆè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
    - `creatorHash` - ä»ç´¢å¼•å™¨æ£€ç´¢çš„ cNFT åˆ›å»ºè€…çš„å“ˆå¸Œï¼›è¿™æ˜¯ç”±ç´¢å¼•å™¨æä¾›çš„å­—ç¬¦ä¸²ï¼Œå¿…é¡»å…ˆè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
    - `nonce` - ç”¨äºç¡®ä¿æ²¡æœ‰ä¸¤ä¸ªå¶å­å…·æœ‰ç›¸åŒçš„å“ˆå¸Œï¼›æ­¤å€¼åº”ä¸ `index` ç›¸åŒ
    - `index` - cNFT çš„å¶å­ä½äº Merkle æ ‘ä¸Šçš„ç´¢å¼•ä½ç½®

ä»¥ä¸‹æ˜¯ç¤ºä¾‹ã€‚è¯·æ³¨æ„ï¼Œä»£ç çš„å‰ä¸‰è¡Œè·å–äº†å…ˆå‰åµŒå¥—åœ¨å¯¹è±¡ä¸­çš„é™„åŠ ä¿¡æ¯ï¼Œå› æ­¤å½“ç»„è£…æŒ‡ä»¤æœ¬èº«æ—¶ï¼Œå®ƒä»¬å·²å‡†å¤‡å°±ç»ªã€‚

```tsx
const treeAuthority = treeAccount.getAuthority()
const leafOwner = new PublicKey(assetData.ownership.owner)
const leafDelegate = assetData.ownership.delegate
	? new PublicKey(assetData.ownership.delegate)
	: leafOwner

const transferIx = createTransferInstruction(
	{
		merkleTree: treePublicKey,
		treeAuthority,
		leafOwner,
		leafDelegate,
		newLeafOwner: receiver,
		logWrapper: SPL_NOOP_PROGRAM_ID,
		compressionProgram: SPL_ACCOUNT_COMPRESSION_PROGRAM_ID,
		anchorRemainingAccounts: proofPath,
	},
	{
		root: [...new PublicKey(assetProof.root.trim()).toBytes()],
		dataHash: [...new PublicKey(assetData.compression.data_hash.trim()).toBytes()],
		creatorHash: [
			...new PublicKey(assetData.compression.creator_hash.trim()).toBytes(),
		],
		nonce: assetData.compression.leaf_id,
		index: assetData.compression.leaf_id,
	}
)
```

## ç»“è®º

æˆ‘ä»¬å·²ç»ä»‹ç»äº†ä¸ cNFTs äº¤äº’æ‰€éœ€çš„ä¸»è¦æŠ€èƒ½ï¼Œä½†å¹¶ä¸å…¨é¢ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ Bubblegum è¿›è¡Œçƒ§æ¯ã€éªŒè¯ã€å§”æ‰˜ç­‰æ“ä½œã€‚æˆ‘ä»¬ä¸ä¼šè¯¦ç»†ä»‹ç»è¿™äº›å†…å®¹ï¼Œä½†è¿™äº›æŒ‡ä»¤ä¸é“¸é€ å’Œè½¬ç§»è¿‡ç¨‹ç±»ä¼¼ã€‚å¦‚æœæ‚¨éœ€è¦è¿™äº›é¢å¤–çš„åŠŸèƒ½ï¼Œè¯·æŸ¥çœ‹ [Bubblegum å®¢æˆ·ç«¯æºä»£ç ](https://github.com/metaplex-foundation/mpl-bubblegum/tree/main/clients/js-solita) å¹¶åˆ©ç”¨å®ƒæä¾›çš„è¾…åŠ©å‡½æ•°ã€‚

è¯·è®°ä½ï¼Œå‹ç¼©æŠ€æœ¯ç›¸å½“æ–°é¢–ã€‚å¯ç”¨çš„å·¥å…·å°†è¿…é€Ÿå‘å±•ï¼Œä½†æ‚¨åœ¨æœ¬è¯¾ç¨‹ä¸­å­¦åˆ°çš„åŸåˆ™å¯èƒ½ä¼šä¿æŒä¸å˜ã€‚è¿™äº›åŸåˆ™ä¹Ÿå¯ä»¥æ‰©å±•åˆ°ä»»æ„çŠ¶æ€çš„å‹ç¼©ï¼Œå› æ­¤è¯·ç¡®ä¿åœ¨è¿™é‡ŒæŒæ¡å®ƒä»¬ï¼Œä»¥ä¾¿ä¸ºæœªæ¥è¯¾ç¨‹ä¸­çš„æ›´æœ‰è¶£çš„å†…å®¹åšå¥½å‡†å¤‡ï¼

# å®éªŒ

è®©æˆ‘ä»¬å¼€å§‹ç»ƒä¹ åˆ›å»ºå’Œæ“ä½œ cNFTsã€‚æˆ‘ä»¬å°†ä¸€èµ·æ„å»ºå°½å¯èƒ½ç®€å•çš„è„šæœ¬ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä» Merkle æ ‘é“¸é€ ä¸€ä¸ª cNFT é›†åˆã€‚

## 1. è·å–èµ·å§‹ä»£ç 

é¦–å…ˆï¼Œä»æˆ‘ä»¬çš„[cNFTå®éªŒå®¤å­˜å‚¨åº“](https://github.com/Unboxed-Software/solana-cnft-demo)çš„`starter`åˆ†æ”¯ä¸­å…‹éš†èµ·å§‹ä»£ç ã€‚

`git clone https://github.com/Unboxed-Software/solana-cnft-demo.git`

`cd solana-cnft-demo`

`npm install`

èŠ±ä¸€äº›æ—¶é—´ç†Ÿæ‚‰æä¾›çš„èµ·å§‹ä»£ç ã€‚æœ€é‡è¦çš„æ˜¯ `utils.ts` ä¸­æä¾›çš„è¾…åŠ©å‡½æ•°å’Œ `uri.ts` ä¸­æä¾›çš„ URIã€‚

`uri.ts` æ–‡ä»¶æä¾›äº†ä¸€ä¸‡ä¸ªç”¨äºæ‚¨çš„ NFT å…ƒæ•°æ®çš„é“¾ä¸‹éƒ¨åˆ†çš„ URIã€‚å½“ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå·±çš„å…ƒæ•°æ®ã€‚ä½†æ˜¯ï¼Œæœ¬è¯¾ç¨‹å¹¶ä¸æ˜ç¡®æ¶‰åŠå‡†å¤‡å…ƒæ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬ä¸ºæ‚¨æä¾›äº†ä¸€äº›ã€‚

`utils.ts` æ–‡ä»¶ä¸­æœ‰ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œå¯ä»¥å¸®åŠ©æ‚¨å‡å°‘ä¸å¿…è¦çš„æ ·æ¿ä»£ç ã€‚å®ƒä»¬å¦‚ä¸‹ï¼š

- `getOrCreateKeypair`ï¼šå°†ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªæ–°çš„å¯†é’¥å¯¹ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° `.env` æ–‡ä»¶ä¸­ï¼Œæˆ–è€…å¦‚æœ `.env` æ–‡ä»¶ä¸­å·²ç»æœ‰ç§é’¥ï¼Œåˆ™å°†ä»è¯¥ç§é’¥åˆå§‹åŒ–ä¸€ä¸ªå¯†é’¥å¯¹ã€‚
- `airdropSolIfNeeded`ï¼šå¦‚æœæŒ‡å®šåœ°å€çš„ä½™é¢ä½äº 1 SOLï¼Œåˆ™å°†ä¸€äº› Devnet SOL ç©ºæŠ•åˆ°è¯¥åœ°å€ã€‚
- `createNftMetadata`ï¼šå°†ä¸ºç»™å®šçš„åˆ›å»ºè€…å…¬é’¥å’Œç´¢å¼•åˆ›å»º NFT å…ƒæ•°æ®ã€‚å®ƒè·å–çš„å…ƒæ•°æ®åªæ˜¯ä½¿ç”¨ `uri.ts` ä¸­æä¾›çš„ URI åˆ—è¡¨ä¸­ç›¸åº”ç´¢å¼•å¯¹åº”çš„ URI åˆ›å»ºçš„è™šæ‹Ÿå…ƒæ•°æ®ã€‚
- `getOrCreateCollectionNFT`ï¼šå°†ä» `.env` ä¸­æŒ‡å®šçš„åœ°å€è·å–é›†åˆ NFTï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„é›†åˆ NFTï¼Œå¹¶å°†åœ°å€æ·»åŠ åˆ° `.env`ã€‚

æœ€åï¼Œåœ¨ `index.ts` ä¸­æœ‰ä¸€äº›æ ·æ¿ä»£ç ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªæ–°çš„ Devnet è¿æ¥ï¼Œè°ƒç”¨ `getOrCreateKeypair` æ¥åˆå§‹åŒ–ä¸€ä¸ªâ€œé’±åŒ…â€ï¼Œå¹¶è°ƒç”¨ `airdropSolIfNeeded` æ¥ä¸ºé’±åŒ…æä¾›èµ„é‡‘ï¼Œå¦‚æœå…¶ä½™é¢è¾ƒä½çš„è¯ã€‚

æˆ‘ä»¬å°†åœ¨ `index.ts` ä¸­ç¼–å†™æˆ‘ä»¬çš„æ‰€æœ‰ä»£ç ã€‚

## 2. åˆ›å»º Merkle æ ‘è´¦æˆ·

æˆ‘ä»¬å°†å¼€å§‹åˆ›å»º Merkle æ ‘è´¦æˆ·ã€‚è®©æˆ‘ä»¬å°†è¿™ä¸ªè¿‡ç¨‹å°è£…åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°æœ€ç»ˆå°†åˆ›å»º *å¹¶ä¸”* åˆå§‹åŒ–è´¦æˆ·ã€‚æˆ‘ä»¬å°†æŠŠå®ƒæ”¾åœ¨ `index.ts` æ–‡ä»¶ä¸­ `main` å‡½æ•°çš„ä¸‹é¢ã€‚æˆ‘ä»¬å°†å…¶å‘½åä¸º `createAndInitializeTree`ã€‚ä¸ºäº†ä½¿è¯¥å‡½æ•°æ­£å¸¸å·¥ä½œï¼Œå®ƒå°†éœ€è¦ä»¥ä¸‹å‚æ•°ï¼š

- `connection` - ç”¨äºä¸ç½‘ç»œäº¤äº’çš„ `Connection`ã€‚
- `payer` - å°†æ”¯ä»˜äº¤æ˜“è´¹ç”¨çš„ `Keypair`ã€‚
- `maxDepthSizePair` - ä¸€ä¸ª `ValidDepthSizePair`ã€‚æ­¤ç±»å‹æ¥è‡ª `@solana/spl-account-compression`ã€‚å®ƒæ˜¯ä¸€ä¸ªç®€å•çš„å¯¹è±¡ï¼Œå…·æœ‰ `maxDepth` å’Œ `maxBufferSize` ä¸¤ä¸ªå±æ€§ï¼Œå¼ºåˆ¶æ‰§è¡Œè¿™ä¸¤ä¸ªå€¼çš„æœ‰æ•ˆç»„åˆã€‚
- `canopyDepth` - ç”¨äºæ ‘å† æ·±åº¦çš„æ•°å­—ã€‚

åœ¨å‡½æ•°ä½“å†…ï¼Œæˆ‘ä»¬å°†ä¸ºæ ‘ç”Ÿæˆä¸€ä¸ªæ–°åœ°å€ï¼Œç„¶åé€šè¿‡è°ƒç”¨ `@solana/spl-account-compression` ä¸­çš„ `createAllocTreeIx` åˆ›å»ºä¸€ä¸ªæ–°çš„ Merkle æ ‘è´¦æˆ·çš„æŒ‡ä»¤ã€‚
    

```tsx
async function createAndInitializeTree(
  connection: Connection,
  payer: Keypair,
  maxDepthSizePair: ValidDepthSizePair,
  canopyDepth: number
) {
	const treeKeypair = Keypair.generate()

	const allocTreeIx = await createAllocTreeIx(
    connection,
    treeKeypair.publicKey,
    payer.publicKey,
    maxDepthSizePair,
    canopyDepth
  )
}
```

## 3. ä½¿ç”¨ Bubblegum åˆå§‹åŒ– Merkle æ ‘å¹¶åˆ›å»ºæ ‘é…ç½®è´¦æˆ·

æœ‰äº†åˆ›å»ºæ ‘çš„æŒ‡ä»¤å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæŒ‡ä»¤æ¥è°ƒç”¨ Bubblegum ç¨‹åºä¸­çš„ `create_tree`ã€‚è¿™å°†åˆå§‹åŒ– Merkle æ ‘è´¦æˆ· *å¹¶ä¸”* åœ¨ Bubblegum ç¨‹åºä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„æ ‘é…ç½®è´¦æˆ·ã€‚

è¿™ä¸ªæŒ‡ä»¤éœ€è¦æˆ‘ä»¬æä¾›ä»¥ä¸‹å†…å®¹ï¼š

- `accounts` - ä¸€ä¸ªåŒ…å«æ‰€éœ€è´¦æˆ·çš„å¯¹è±¡ï¼›è¿™åŒ…æ‹¬ï¼š
    - `treeAuthority` - è¿™åº”è¯¥æ˜¯ä¸€ä¸ªç”± Merkle æ ‘åœ°å€å’Œ Bubblegum ç¨‹åºæ´¾ç”Ÿçš„ PDAã€‚
    - `merkleTree` - Merkle æ ‘çš„åœ°å€ã€‚
    - `payer` - äº¤æ˜“è´¹æ”¯ä»˜è€…ã€‚
    - `treeCreator` - æ ‘åˆ›å»ºè€…çš„åœ°å€ï¼›æˆ‘ä»¬å°†å…¶è®¾ç½®ä¸ºä¸ `payer` ç›¸åŒã€‚
    - `logWrapper` - å°†å…¶è®¾ç½®ä¸º `SPL_NOOP_PROGRAM_ID`ã€‚
    - `compressionProgram` - å°†å…¶è®¾ç½®ä¸º `SPL_ACCOUNT_COMPRESSION_PROGRAM_ID`ã€‚
- `args` - ä¸€ä¸ªæŒ‡ä»¤å‚æ•°åˆ—è¡¨ï¼›è¿™åŒ…æ‹¬ï¼š
    - `maxBufferSize` - æ¥è‡ªæˆ‘ä»¬å‡½æ•°çš„ `maxDepthSizePair` å‚æ•°çš„ç¼“å†²åŒºå¤§å°ã€‚
    - `maxDepth` - æ¥è‡ªæˆ‘ä»¬å‡½æ•°çš„ `maxDepthSizePair` å‚æ•°çš„æœ€å¤§æ·±åº¦ã€‚
    - `public` - æ ‘æ˜¯å¦åº”è¯¥æ˜¯å…¬å¼€çš„ï¼›æˆ‘ä»¬å°†å…¶è®¾ç½®ä¸º `false`ã€‚

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸¤ä¸ªæŒ‡ä»¤æ·»åŠ åˆ°ä¸€ä¸ªäº¤æ˜“ä¸­å¹¶æäº¤äº¤æ˜“ã€‚è¯·è®°ä½ï¼Œäº¤æ˜“éœ€è¦ç”± `payer` å’Œ `treeKeypair` ç­¾åã€‚

```tsx
async function createAndInitializeTree(
  connection: Connection,
  payer: Keypair,
  maxDepthSizePair: ValidDepthSizePair,
  canopyDepth: number
) {
	const treeKeypair = Keypair.generate()

	const allocTreeIx = await createAllocTreeIx(
    connection,
    treeKeypair.publicKey,
    payer.publicKey,
    maxDepthSizePair,
    canopyDepth
  )

	const [treeAuthority, _bump] = PublicKey.findProgramAddressSync(
    [treeKeypair.publicKey.toBuffer()],
    BUBBLEGUM_PROGRAM_ID
  )

	const createTreeIx = createCreateTreeInstruction(
    {
      treeAuthority,
      merkleTree: treeKeypair.publicKey,
      payer: payer.publicKey,
      treeCreator: payer.publicKey,
      logWrapper: SPL_NOOP_PROGRAM_ID,
      compressionProgram: SPL_ACCOUNT_COMPRESSION_PROGRAM_ID,
    },
    {
      maxBufferSize: maxDepthSizePair.maxBufferSize,
      maxDepth: maxDepthSizePair.maxDepth,
      public: false,
    }
  )

	const tx = new Transaction().add(allocTreeIx, createTreeIx)
  tx.feePayer = payer.publicKey
  
  try {
    const txSignature = await sendAndConfirmTransaction(
      connection,
      tx,
      [treeKeypair, payer],
      {
        commitment: "confirmed",
        skipPreflight: true,
      }
    )

    console.log(`https://explorer.solana.com/tx/${txSignature}?cluster=devnet`)

    console.log("Tree Address:", treeKeypair.publicKey.toBase58())

    return treeKeypair.publicKey
  } catch (err: any) {
    console.error("\nFailed to create merkle tree:", err)
    throw err
  }
}
```

å¦‚æœä½ æƒ³æµ‹è¯•åˆ°ç›®å‰ä¸ºæ­¢çš„å†…å®¹ï¼Œå¯ä»¥éšæ—¶ä» `main` è°ƒç”¨ `createAndInitializeTree`ï¼Œå¹¶ä¸ºæœ€å¤§æ·±åº¦å’Œæœ€å¤§ç¼“å†²åŒºå¤§å°æä¾›å°çš„å€¼ã€‚

```tsx
async function main() {
  const connection = new Connection(clusterApiUrl("devnet"), "confirmed")
  const wallet = await getOrCreateKeypair("Wallet_1")
  await airdropSolIfNeeded(wallet.publicKey)

  const maxDepthSizePair: ValidDepthSizePair = {
    maxDepth: 3,
    maxBufferSize: 8,
  }

  const canopyDepth = 0

  const treeAddress = await createAndInitializeTree(
    connection,
    wallet,
    maxDepthSizePair,
    canopyDepth
  )
}
```

è¯·è®°ä½ï¼ŒDevnet SOL å—åˆ°é™åˆ¶ï¼Œå¦‚æœæµ‹è¯•æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½ä¼šåœ¨æˆ‘ä»¬è¿›è¡Œé“¸å¸ä¹‹å‰ç”¨å®Œ Devnet SOLã€‚è¦è¿›è¡Œæµ‹è¯•ï¼Œè¯·åœ¨æ‚¨çš„ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

`npm run start`

## 4. å°† cNFT é“¸é€ åˆ°æ‚¨çš„æ ‘ä¸­

ä¿¡ä¸ä¿¡ç”±ä½ ï¼Œè¿™å°±æ˜¯ä½ è®¾ç½®æ ‘æ¥å‹ç¼© NFT æ‰€éœ€åšçš„ä¸€åˆ‡ï¼ç°åœ¨è®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›è½¬å‘é“¸é€ ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å£°æ˜ä¸€ä¸ªåä¸º `mintCompressedNftToCollection` çš„å‡½æ•°ã€‚å®ƒå°†éœ€è¦ä»¥ä¸‹å‚æ•°ï¼š

- `connection` - ç”¨äºä¸ç½‘ç»œäº¤äº’çš„ `Connection`ã€‚
- `payer` - å°†æ”¯ä»˜äº¤æ˜“è´¹ç”¨çš„ `Keypair`ã€‚
- `treeAddress` - Merkle æ ‘çš„åœ°å€ã€‚
- `collectionDetails` - ç±»å‹ä¸º `utils.ts` ä¸­çš„ `CollectionDetails` çš„é›†åˆè¯¦æƒ…ã€‚
- `amount` - è¦é“¸é€ çš„ cNFT æ•°é‡ã€‚

è¿™ä¸ªå‡½æ•°çš„ä¸»ä½“å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. åƒä¹‹å‰ä¸€æ ·æ´¾ç”Ÿæ ‘æƒé™ã€‚åŒæ ·ï¼Œè¿™æ˜¯ä¸€ä¸ªç”± Merkle æ ‘åœ°å€å’Œ Bubblegum ç¨‹åºæ´¾ç”Ÿçš„ PDAã€‚
2. æ´¾ç”Ÿ `bubblegumSigner`ã€‚è¿™æ˜¯ä¸€ä¸ªç”±å­—ç¬¦ä¸² `"collection_cpi"` å’Œ Bubblegum ç¨‹åºæ´¾ç”Ÿçš„ PDAï¼Œå¹¶ä¸”å¯¹äºå‘é›†åˆé“¸é€ æ˜¯å¿…ä¸å¯å°‘çš„ã€‚
3. é€šè¿‡è°ƒç”¨æˆ‘ä»¬çš„ `utils.ts` æ–‡ä»¶ä¸­çš„ `createNftMetadata` åˆ›å»º cNFT å…ƒæ•°æ®ã€‚
4. é€šè¿‡è°ƒç”¨ Bubblegum SDK ä¸­çš„ `createMintToCollectionV1Instruction` åˆ›å»ºé“¸é€ æŒ‡ä»¤ã€‚
5. æ„å»ºå¹¶å‘é€ä¸€ä¸ªåŒ…å«é“¸é€ æŒ‡ä»¤çš„äº¤æ˜“ã€‚
6. é‡å¤æ­¥éª¤ 3-6 `amount` æ¬¡ã€‚

`createMintToCollectionV1Instruction` æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š`accounts` å’Œ `args`ã€‚åè€…ç®€å•åœ°æ˜¯ NFT å…ƒæ•°æ®ã€‚ä¸æ‰€æœ‰å¤æ‚æŒ‡ä»¤ä¸€æ ·ï¼Œä¸»è¦éš¾ç‚¹åœ¨äºçŸ¥é“è¦æä¾›å“ªäº›è´¦æˆ·ã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬å¿«é€Ÿæµè§ˆä¸€ä¸‹å®ƒä»¬ï¼š

- `payer` - æ”¯ä»˜äº¤æ˜“è´¹ã€ç§Ÿé‡‘ç­‰çš„è´¦æˆ·ã€‚
- `merkleTree` - Merkle æ ‘è´¦æˆ·ã€‚
- `treeAuthority` - æ ‘æˆæƒæ–¹ï¼›åº”è¯¥ä¸ä¹‹å‰æ´¾ç”Ÿçš„ PDA ç›¸åŒã€‚
- `treeDelegate` - æ ‘å§”æ‰˜æ–¹ï¼›é€šå¸¸ä¸æ ‘åˆ›å»ºè€…ç›¸åŒã€‚
- `leafOwner` - æ­£åœ¨é“¸é€ çš„å‹ç¼© NFT çš„æœŸæœ›æ‰€æœ‰è€…ã€‚
- `leafDelegate` - æ­£åœ¨é“¸é€ çš„å‹ç¼© NFT çš„æœŸæœ›å§”æ‰˜è€…ï¼›é€šå¸¸ä¸å¶å­æ‰€æœ‰è€…ç›¸åŒã€‚
- `collectionAuthority` - é›†åˆ NFT çš„æˆæƒæ–¹ã€‚
- `collectionAuthorityRecordPda` - å¯é€‰çš„é›†åˆæˆæƒè®°å½• PDAï¼›é€šå¸¸ä¸å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åº”å°† Bubblegum ç¨‹åºåœ°å€æ”¾åœ¨æ­¤å¤„ã€‚
- `collectionMint` - é›†åˆ NFT çš„é“¸é€ è´¦æˆ·ã€‚
- `collectionMetadata` - é›†åˆ NFT çš„å…ƒæ•°æ®è´¦æˆ·ã€‚
- `editionAccount` - é›†åˆ NFT çš„ä¸»ç‰ˆæœ¬è´¦æˆ·ã€‚
- `compressionProgram` - è¦ä½¿ç”¨çš„å‹ç¼©ç¨‹åºï¼›é™¤éæ‚¨æœ‰å…¶ä»–è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™åº”è¯¥æ˜¯ SPL çŠ¶æ€å‹ç¼©ç¨‹åºçš„åœ°å€ã€‚
- `logWrapper` - ç”¨äºé€šè¿‡æ—¥å¿—å‘ç´¢å¼•å™¨å…¬å¼€æ•°æ®çš„ç¨‹åºï¼›é™¤éæ‚¨æœ‰å…¶ä»–è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™åº”è¯¥æ˜¯ SPL Noop ç¨‹åºçš„åœ°å€ã€‚
- `bubblegumSigner` - Bubblegum ç¨‹åºç”¨äºå¤„ç†é›†åˆéªŒè¯çš„ PDAã€‚
- `tokenMetadataProgram` - ç”¨äºé›†åˆ NFT çš„ä»£å¸å…ƒæ•°æ®ç¨‹åºï¼›é€šå¸¸å§‹ç»ˆæ˜¯ Metaplex ä»£å¸å…ƒæ•°æ®ç¨‹åºã€‚

å°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```tsx
async function mintCompressedNftToCollection(
  connection: Connection,
  payer: Keypair,
  treeAddress: PublicKey,
  collectionDetails: CollectionDetails,
  amount: number
) {
  // Derive the tree authority PDA ('TreeConfig' account for the tree account)
  const [treeAuthority] = PublicKey.findProgramAddressSync(
    [treeAddress.toBuffer()],
    BUBBLEGUM_PROGRAM_ID
  )

  // Derive the bubblegum signer, used by the Bubblegum program to handle "collection verification"
  // Only used for `createMintToCollectionV1` instruction
  const [bubblegumSigner] = PublicKey.findProgramAddressSync(
    [Buffer.from("collection_cpi", "utf8")],
    BUBBLEGUM_PROGRAM_ID
  )

  for (let i = 0; i < amount; i++) {
    // Compressed NFT Metadata
    const compressedNFTMetadata = createNftMetadata(payer.publicKey, i)

    // Create the instruction to "mint" the compressed NFT to the tree
    const mintIx = createMintToCollectionV1Instruction(
      {
        payer: payer.publicKey, // The account that will pay for the transaction
        merkleTree: treeAddress, // The address of the tree account
        treeAuthority, // The authority of the tree account, should be a PDA derived from the tree account address
        treeDelegate: payer.publicKey, // The delegate of the tree account, should be the same as the tree creator by default
        leafOwner: payer.publicKey, // The owner of the compressed NFT being minted to the tree
        leafDelegate: payer.publicKey, // The delegate of the compressed NFT being minted to the tree
        collectionAuthority: payer.publicKey, // The authority of the "collection" NFT
        collectionAuthorityRecordPda: BUBBLEGUM_PROGRAM_ID, // Must be the Bubblegum program id
        collectionMint: collectionDetails.mint, // The mint of the "collection" NFT
        collectionMetadata: collectionDetails.metadata, // The metadata of the "collection" NFT
        editionAccount: collectionDetails.masterEditionAccount, // The master edition of the "collection" NFT
        compressionProgram: SPL_ACCOUNT_COMPRESSION_PROGRAM_ID,
        logWrapper: SPL_NOOP_PROGRAM_ID,
        bubblegumSigner,
        tokenMetadataProgram: TOKEN_METADATA_PROGRAM_ID,
      },
      {
        metadataArgs: Object.assign(compressedNFTMetadata, {
          collection: { key: collectionDetails.mint, verified: false },
        }),
      }
    )

    try {
      // Create new transaction and add the instruction
      const tx = new Transaction().add(mintIx)

      // Set the fee payer for the transaction
      tx.feePayer = payer.publicKey

      // Send the transaction
      const txSignature = await sendAndConfirmTransaction(
        connection,
        tx,
        [payer],
        { commitment: "confirmed", skipPreflight: true }
      )

      console.log(
        `https://explorer.solana.com/tx/${txSignature}?cluster=devnet`
      )
    } catch (err) {
      console.error("\nFailed to mint compressed NFT:", err)
      throw err
    }
  }
}
```

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ—¶æœºæ¥æµ‹è¯•ä¸€ä¸ªå°æ ‘ã€‚åªéœ€æ›´æ–° `main` å‡½æ•°æ¥è°ƒç”¨ `getOrCreateCollectionNFT` ç„¶åè°ƒç”¨ `mintCompressedNftToCollection`ï¼š

```tsx
async function main() {
  const connection = new Connection(clusterApiUrl("devnet"), "confirmed")
  const wallet = await getOrCreateKeypair("Wallet_1")
  await airdropSolIfNeeded(wallet.publicKey)

  const maxDepthSizePair: ValidDepthSizePair = {
    maxDepth: 3,
    maxBufferSize: 8,
  }

  const canopyDepth = 0

  const treeAddress = await createAndInitializeTree(
    connection,
    wallet,
    maxDepthSizePair,
    canopyDepth
  )

  const collectionNft = await getOrCreateCollectionNFT(connection, wallet)

  await mintCompressedNftToCollection(
    connection,
    wallet,
    treeAddress,
    collectionNft,
    2 ** maxDepthSizePair.maxDepth
  )
}
```

å†æ¬¡è¿è¡Œï¼Œè¯·åœ¨æ‚¨çš„ç»ˆç«¯ä¸­é”®å…¥ï¼š`npm run start`

## 5. è¯»å–ç°æœ‰çš„ cNFT æ•°æ®

æ—¢ç„¶æˆ‘ä»¬å·²ç»ç¼–å†™äº†ç”¨äºé“¸é€  cNFT çš„ä»£ç ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥å®é™…è·å–å®ƒä»¬çš„æ•°æ®ã€‚è¿™æœ‰ç‚¹æ£˜æ‰‹ï¼Œå› ä¸ºé“¾ä¸Šæ•°æ®åªæ˜¯ merkle æ ‘è´¦æˆ·ï¼Œå…¶ä¸­çš„æ•°æ®å¯ç”¨äºéªŒè¯ç°æœ‰ä¿¡æ¯çš„å‡†ç¡®æ€§ï¼Œä½†åœ¨ä¼ è¾¾ä¿¡æ¯æ˜¯æ— ç”¨çš„ã€‚

è®©æˆ‘ä»¬ä»å£°æ˜ä¸€ä¸ªåä¸º `logNftDetails` çš„å‡½æ•°å¼€å§‹ï¼Œè¯¥å‡½æ•°æ¥å— `treeAddress` å’Œ `nftsMinted` ä½œä¸ºå‚æ•°ã€‚

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬å®é™…ä¸Šæ²¡æœ‰ä»»ä½•ç›´æ¥çš„æ ‡è¯†ç¬¦æŒ‡å‘æˆ‘ä»¬çš„ cNFTã€‚ä¸ºäº†è·å–å®ƒï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“åœ¨é“¸é€  cNFT æ—¶ä½¿ç”¨çš„å¶ç´¢å¼•ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç´¢å¼•æ¥å¯¼å‡ºç”± Read API ä½¿ç”¨çš„èµ„äº§ IDï¼Œéšåä½¿ç”¨ Read API è·å–æˆ‘ä»¬çš„ cNFT æ•°æ®ã€‚

åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªéå…¬å¼€çš„æ ‘å¹¶é“¸é€ äº† 8 ä¸ª cNFTï¼Œå› æ­¤æˆ‘ä»¬çŸ¥é“ä½¿ç”¨çš„å¶ç´¢å¼•æ˜¯ 0-7ã€‚æœ‰äº†è¿™ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `@metaplex-foundation/mpl-bubblegum` ä¸­çš„ `getLeafAssetId` å‡½æ•°æ¥è·å–èµ„äº§ IDã€‚

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ”¯æŒ [Read API](https://docs.solana.com/developing/guides/compressed-nfts#reading-compressed-nfts-metadata) çš„ RPC æ¥è·å–èµ„äº§ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ [Helius](https://docs.helius.dev/compression-and-das-api/digital-asset-standard-das-api)ï¼Œä½†è¯·éšæ„é€‰æ‹©æ‚¨è‡ªå·±çš„ RPC æä¾›ç¨‹åºã€‚è¦ä½¿ç”¨ Heliusï¼Œæ‚¨éœ€è¦ä» [ä»–ä»¬çš„ç½‘ç«™](https://dev.helius.xyz/) è·å–å…è´¹çš„ API å¯†é’¥ã€‚ç„¶åå°†æ‚¨çš„ `RPC_URL` æ·»åŠ åˆ°æ‚¨çš„ `.env` æ–‡ä»¶ä¸­ã€‚ä¾‹å¦‚ï¼š

```bash
# Add this
RPC_URL=https://devnet.helius-rpc.com/?api-key=YOUR_API_KEY
```

ç„¶åï¼Œåªéœ€å‘æ‚¨æä¾›çš„ RPC URL å‘å‡ºä¸€ä¸ª POST è¯·æ±‚ï¼Œå¹¶å°† `getAsset` ä¿¡æ¯æ”¾å…¥è¯·æ±‚ä½“ä¸­ï¼š

```tsx
async function logNftDetails(treeAddress: PublicKey, nftsMinted: number) {
  for (let i = 0; i < nftsMinted; i++) {
    const assetId = await getLeafAssetId(treeAddress, new BN(i))
    console.log("Asset ID:", assetId.toBase58())
    const response = await fetch(process.env.RPC_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        jsonrpc: "2.0",
        id: "my-id",
        method: "getAsset",
        params: {
          id: assetId,
        },
      }),
    })
    const { result } = await response.json()
    console.log(JSON.stringify(result, null, 2))
  }
}
```

Helius åŸºæœ¬ä¸Šä¼šåœ¨äº¤æ˜“æ—¥å¿—å‘ç”Ÿæ—¶è§‚å¯Ÿå¹¶å­˜å‚¨ NFT å…ƒæ•°æ®ï¼Œè¿™äº›å…ƒæ•°æ®å·²ç»è¢«å“ˆå¸Œå¹¶å­˜å‚¨åœ¨é»˜å…‹å°”æ ‘ä¸­ã€‚è¿™ä½¿å¾—ä»–ä»¬åœ¨è¢«è¯·æ±‚æ—¶èƒ½å¤Ÿæä¾›è¿™äº›æ•°æ®ã€‚

å¦‚æœæˆ‘ä»¬åœ¨ `main` çš„ç»“å°¾æ·»åŠ ä¸€ä¸ªè°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ“ä½œï¼Œå¹¶é‡æ–°è¿è¡Œæ‚¨çš„è„šæœ¬ï¼Œé‚£ä¹ˆåœ¨æ§åˆ¶å°ä¸­æˆ‘ä»¬å¾—åˆ°çš„æ•°æ®ä¼šéå¸¸å…¨é¢ã€‚å®ƒåŒ…æ‹¬äº†ä¼ ç»Ÿ NFT çš„é“¾ä¸Šå’Œé“¾ä¸‹éƒ¨åˆ†ä¸­æ‚¨æ‰€æœŸæœ›çš„æ‰€æœ‰æ•°æ®ã€‚æ‚¨å¯ä»¥æ‰¾åˆ° cNFT çš„å±æ€§ã€æ–‡ä»¶ã€æ‰€æœ‰æƒå’Œåˆ›å»ºè€…ä¿¡æ¯ç­‰ç­‰ã€‚

```json
{
  "interface": "V1_NFT",
  "id": "48Bw561h1fGFK4JGPXnmksHp2fpniEL7hefEc6uLZPWN",
  "content": {
    "$schema": "https://schema.metaplex.com/nft1.0.json",
    "json_uri": "https://raw.githubusercontent.com/Unboxed-Software/rgb-png-generator/master/assets/183_89_78/183_89_78.json",
    "files": [
      {
        "uri": "https://raw.githubusercontent.com/Unboxed-Software/rgb-png-generator/master/assets/183_89_78/183_89_78.png",
        "cdn_uri": "https://cdn.helius-rpc.com/cdn-cgi/image//https://raw.githubusercontent.com/Unboxed-Software/rgb-png-generator/master/assets/183_89_78/183_89_78.png",
        "mime": "image/png"
      }
    ],
    "metadata": {
      "attributes": [
        {
          "value": "183",
          "trait_type": "R"
        },
        {
          "value": "89",
          "trait_type": "G"
        },
        {
          "value": "78",
          "trait_type": "B"
        }
      ],
      "description": "Random RGB Color",
      "name": "CNFT",
      "symbol": "CNFT"
    },
    "links": {
      "image": "https://raw.githubusercontent.com/Unboxed-Software/rgb-png-generator/master/assets/183_89_78/183_89_78.png"
    }
  },
  "authorities": [
    {
      "address": "DeogHav5T2UV1zf5XuH4DTwwE5fZZt7Z4evytUUtDtHd",
      "scopes": [
        "full"
      ]
    }
  ],
  "compression": {
    "eligible": false,
    "compressed": true,
    "data_hash": "3RsXHMBDpUPojPLZuMyKgZ1kbhW81YSY3PYmPZhbAx8K",
    "creator_hash": "Di6ufEixhht76sxutC9528H7PaWuPz9hqTaCiQxoFdr",
    "asset_hash": "2TwWjQPdGc5oVripPRCazGBpAyC5Ar1cia8YKUERDepE",
    "tree": "7Ge8nhDv2FcmnpyfvuWPnawxquS6gSidum38oq91Q7vE",
    "seq": 8,
    "leaf_id": 7
  },
  "grouping": [
    {
      "group_key": "collection",
      "group_value": "9p2RqBUAadMznAFiBEawMJnKR9EkFV98wKgwAz8nxLmj"
    }
  ],
  "royalty": {
    "royalty_model": "creators",
    "target": null,
    "percent": 0,
    "basis_points": 0,
    "primary_sale_happened": false,
    "locked": false
  },
  "creators": [
    {
      "address": "HASk3AoTPAvC1KnXSo6Qm73zpkEtEhbmjLpXLgvyKBkR",
      "share": 100,
      "verified": false
    }
  ],
  "ownership": {
    "frozen": false,
    "delegated": false,
    "delegate": null,
    "ownership_model": "single",
    "owner": "HASk3AoTPAvC1KnXSo6Qm73zpkEtEhbmjLpXLgvyKBkR"
  },
  "supply": {
    "print_max_supply": 0,
    "print_current_supply": 0,
    "edition_nonce": 0
  },
  "mutable": false,
  "burnt": false
}
```

è¯·è®°ä½ï¼Œè¯»å– API è¿˜åŒ…æ‹¬è·å–å¤šä¸ªèµ„äº§ã€æŒ‰æ‰€æœ‰è€…ã€åˆ›å»ºè€…ç­‰è¿›è¡ŒæŸ¥è¯¢ç­‰åŠŸèƒ½ã€‚åŠ¡å¿…æŸ¥çœ‹ [Helius æ–‡æ¡£](https://docs.helius.dev/compression-and-das-api/digital-asset-standard-das-api) ä»¥äº†è§£å¯ç”¨çš„åŠŸèƒ½ã€‚

## 6. è½¬ç§» cNFT

æˆ‘ä»¬è¦å‘è„šæœ¬ä¸­æ·»åŠ çš„æœ€åä¸€é¡¹åŠŸèƒ½æ˜¯ cNFT çš„è½¬ç§»ã€‚ä¸æ ‡å‡†çš„ SPL ä»£å¸è½¬ç§»ä¸€æ ·ï¼Œå®‰å…¨æ€§è‡³å…³é‡è¦ã€‚ç„¶è€Œï¼Œä¸æ ‡å‡†çš„ SPL ä»£å¸è½¬ç§»ä¸åŒçš„æ˜¯ï¼Œåœ¨æ„å»ºä»»ä½•ç±»å‹çš„å…·æœ‰çŠ¶æ€å‹ç¼©çš„å®‰å…¨è½¬ç§»æ—¶ï¼Œæ‰§è¡Œè½¬ç§»çš„ç¨‹åºéœ€è¦æ•´ä¸ªèµ„äº§æ•°æ®ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ Bubblegum éœ€è¦æä¾›æ•´ä¸ªå·²å“ˆå¸Œå¹¶å­˜å‚¨åœ¨ç›¸åº”å¶å­ä¸Šçš„æ•°æ®ï¼Œå¹¶ä¸”éœ€è¦æä¾›æœ‰å…³æ‰€è®¨è®ºå¶å­çš„â€œè¯æ˜è·¯å¾„â€ã€‚è¿™ä½¿å¾— cNFT çš„è½¬ç§»æ¯” SPL ä»£å¸çš„è½¬ç§»å¤æ‚ä¸€äº›ã€‚

è¯·è®°ä½ï¼Œä¸€èˆ¬çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. ä»ç´¢å¼•å™¨è·å– cNFT çš„èµ„äº§æ•°æ®
2. ä»ç´¢å¼•å™¨è·å– cNFT çš„è¯æ˜
3. ä» Solana åŒºå—é“¾è·å– Merkle æ ‘è´¦æˆ·
4. å‡†å¤‡èµ„äº§è¯æ˜ï¼Œä»¥ `AccountMeta` å¯¹è±¡åˆ—è¡¨çš„å½¢å¼
5. æ„å»ºå¹¶å‘é€ Bubblegum è½¬è´¦æŒ‡ä»¤

è®©æˆ‘ä»¬é¦–å…ˆå£°æ˜ä¸€ä¸ªåä¸º `transferNft` çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä»¥ä¸‹å‚æ•°ï¼š

- `connection` - ä¸€ä¸ª `Connection` å¯¹è±¡
- `assetId` - ä¸€ä¸ª `PublicKey` å¯¹è±¡
- `sender` - ä¸€ä¸ª `Keypair` å¯¹è±¡ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ç­¾ç½²äº¤æ˜“
- `receiver` - ä¸€ä¸ªè¡¨ç¤ºæ–°æ‰€æœ‰è€…çš„ `PublicKey` å¯¹è±¡

åœ¨è¯¥å‡½æ•°å†…éƒ¨ï¼Œè®©æˆ‘ä»¬å†æ¬¡è·å–èµ„äº§æ•°æ®ï¼Œç„¶åä¹Ÿè·å–èµ„äº§è¯æ˜ã€‚ä¸ºäº†ä¿é™©èµ·è§ï¼Œè®©æˆ‘ä»¬å°†æ‰€æœ‰å†…å®¹éƒ½åŒ…è£¹åœ¨ `try catch` ä¸­ã€‚

```tsx
async function transferNft(
  connection: Connection,
  assetId: PublicKey,
  sender: Keypair,
  receiver: PublicKey
) {
  try {
    const assetDataResponse = await fetch(process.env.RPC_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        jsonrpc: "2.0",
        id: "my-id",
        method: "getAsset",
        params: {
          id: assetId,
        },
      }),
    })
    const assetData = (await assetDataResponse.json()).result

    const assetProofResponse = await fetch(process.env.RPC_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        jsonrpc: "2.0",
        id: "my-id",
        method: "getAssetProof",
        params: {
          id: assetId,
        },
      }),
    })
    const assetProof = (await assetProofResponse.json()).result
	} catch (err: any) {
    console.error("\nFailed to transfer nft:", err)
    throw err
	}
}
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä»é“¾ä¸Šè·å– Merkle æ ‘è´¦æˆ·ï¼Œè·å–æ ‘å† æ·±åº¦ï¼Œå¹¶ç»„è£…è¯æ˜è·¯å¾„ã€‚æˆ‘ä»¬é€šè¿‡å°†ä» Helius è·å–çš„èµ„äº§è¯æ˜æ˜ å°„åˆ°ä¸€ä¸ª `AccountMeta` å¯¹è±¡åˆ—è¡¨æ¥å®Œæˆè¿™ä¸€æ­¥ï¼Œç„¶åç§»é™¤ä»»ä½•å·²åœ¨æ ‘å† ä¸Šç¼“å­˜çš„è¯æ˜èŠ‚ç‚¹ã€‚

```tsx
async function transferNft(
  connection: Connection,
  assetId: PublicKey,
  sender: Keypair,
  receiver: PublicKey
) {
  try {
    ...

    const treePublicKey = new PublicKey(assetData.compression.tree)

    const treeAccount = await ConcurrentMerkleTreeAccount.fromAccountAddress(
      connection,
      treePublicKey
    )

    const canopyDepth = treeAccount.getCanopyDepth() || 0

    const proofPath: AccountMeta[] = assetProof.proof
      .map((node: string) => ({
        pubkey: new PublicKey(node),
        isSigner: false,
        isWritable: false,
      }))
      .slice(0, assetProof.proof.length - canopyDepth)
  } catch (err: any) {
    console.error("\nFailed to transfer nft:", err)
    throw err
  }
}
```

æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨ `createTransferInstruction` æ„å»ºæŒ‡ä»¤ï¼Œå°†å…¶æ·»åŠ åˆ°äº¤æ˜“ä¸­ï¼Œç„¶åç­¾åå¹¶å‘é€äº¤æ˜“ã€‚å®Œæˆåï¼Œ`transferNft` å‡½æ•°çš„æ•´ä½“å½¢å¼å¦‚ä¸‹ï¼š

```tsx
async function transferNft(
  connection: Connection,
  assetId: PublicKey,
  sender: Keypair,
  receiver: PublicKey
) {
  try {
    const assetDataResponse = await fetch(process.env.RPC_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        jsonrpc: "2.0",
        id: "my-id",
        method: "getAsset",
        params: {
          id: assetId,
        },
      }),
    })
    const assetData = (await assetDataResponse.json()).result

    const assetProofResponse = await fetch(process.env.RPC_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        jsonrpc: "2.0",
        id: "my-id",
        method: "getAssetProof",
        params: {
          id: assetId,
        },
      }),
    })
    const assetProof = (await assetProofResponse.json()).result

    const treePublicKey = new PublicKey(assetData.compression.tree)

    const treeAccount = await ConcurrentMerkleTreeAccount.fromAccountAddress(
      connection,
      treePublicKey
    )

    const canopyDepth = treeAccount.getCanopyDepth() || 0

    const proofPath: AccountMeta[] = assetProof.proof
      .map((node: string) => ({
        pubkey: new PublicKey(node),
        isSigner: false,
        isWritable: false,
      }))
      .slice(0, assetProof.proof.length - canopyDepth)

    const treeAuthority = treeAccount.getAuthority()
    const leafOwner = new PublicKey(assetData.ownership.owner)
    const leafDelegate = assetData.ownership.delegate
      ? new PublicKey(assetData.ownership.delegate)
      : leafOwner

    const transferIx = createTransferInstruction(
      {
        merkleTree: treePublicKey,
        treeAuthority,
        leafOwner,
        leafDelegate,
        newLeafOwner: receiver,
        logWrapper: SPL_NOOP_PROGRAM_ID,
        compressionProgram: SPL_ACCOUNT_COMPRESSION_PROGRAM_ID,
        anchorRemainingAccounts: proofPath,
      },
      {
        root: [...new PublicKey(assetProof.root.trim()).toBytes()],
        dataHash: [
          ...new PublicKey(assetData.compression.data_hash.trim()).toBytes(),
        ],
        creatorHash: [
          ...new PublicKey(assetData.compression.creator_hash.trim()).toBytes(),
        ],
        nonce: assetData.compression.leaf_id,
        index: assetData.compression.leaf_id,
      }
    )

    const tx = new Transaction().add(transferIx)
    tx.feePayer = sender.publicKey
    const txSignature = await sendAndConfirmTransaction(
      connection,
      tx,
      [sender],
      {
        commitment: "confirmed",
        skipPreflight: true,
      }
    )
    console.log(`https://explorer.solana.com/tx/${txSignature}?cluster=devnet`)
  } catch (err: any) {
    console.error("\nFailed to transfer nft:", err)
    throw err
  }
}
```

è®©æˆ‘ä»¬å°†æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå‹ç¼© NFTï¼ˆç´¢å¼•ä¸º 0ï¼‰è½¬ç§»ç»™å…¶ä»–äººã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¯åŠ¨å¦ä¸€ä¸ªå¸¦æœ‰ä¸€äº›èµ„é‡‘çš„é’±åŒ…ï¼Œç„¶åä½¿ç”¨ `getLeafAssetId` è·å–ç´¢å¼•ä¸º 0 çš„èµ„äº§IDã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œè½¬ç§»æ“ä½œã€‚æœ€åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æˆ‘ä»¬çš„å‡½æ•° `logNftDetails` æ‰“å°å‡ºæ•´ä¸ªæ”¶è—å“ã€‚æ‚¨å°†æ³¨æ„åˆ°ï¼Œç´¢å¼•ä¸º 0 çš„ NFT ç°åœ¨å°†åœ¨ `ownership` å­—æ®µä¸­å±äºæˆ‘ä»¬çš„æ–°é’±åŒ…ã€‚

```tsx
async function main() {
  const connection = new Connection(clusterApiUrl("devnet"), "confirmed")
  const wallet = await getOrCreateKeypair("Wallet_1")
  await airdropSolIfNeeded(wallet.publicKey)

  const maxDepthSizePair: ValidDepthSizePair = {
    maxDepth: 3,
    maxBufferSize: 8,
  }

  const canopyDepth = 0

  const treeAddress = await createAndInitializeTree(
    connection,
    wallet,
    maxDepthSizePair,
    canopyDepth
  )

  const collectionNft = await getOrCreateCollectionNFT(connection, wallet)

  await mintCompressedNftToCollection(
    connection,
    wallet,
    treeAddress,
    collectionNft,
    2 ** maxDepthSizePair.maxDepth
  )

  const recieverWallet = await getOrCreateKeypair("Wallet_2")
  const assetId = await getLeafAssetId(treeAddress, new BN(0))
  await airdropSolIfNeeded(recieverWallet.publicKey)

  console.log(`Transfering ${assetId.toString()} from ${wallet.publicKey.toString()} to ${recieverWallet.publicKey.toString()}`)

  await transferNft(
    connection,
    assetId,
    wallet,
    recieverWallet.publicKey
  )

  await logNftDetails(treeAddress, 8)
}
```

è¯·æ‰§è¡Œæ‚¨çš„è„šæœ¬ã€‚æ•´ä¸ªè¿‡ç¨‹åº”è¯¥å¯ä»¥é¡ºåˆ©æ‰§è¡Œï¼Œè€Œä¸”å‡ ä¹åªéœ€ 0.01 SOLï¼

æ­å–œï¼ç°åœ¨æ‚¨çŸ¥é“å¦‚ä½•é“¸é€ ã€è¯»å–å’Œè½¬ç§» cNFT äº†ã€‚å¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨å¯ä»¥å°†æœ€å¤§æ·±åº¦ã€æœ€å¤§ç¼“å†²åŒºå¤§å°å’Œ Canopy æ·±åº¦æ›´æ–°ä¸ºæ›´å¤§çš„å€¼ï¼Œåªè¦æ‚¨æœ‰è¶³å¤Ÿçš„ Devnet SOLï¼Œè¿™ä¸ªè„šæœ¬å°±å¯ä»¥è®©æ‚¨é“¸é€ å¤šè¾¾ 10,000 ä¸ª cNFTï¼Œæˆæœ¬ä»…ä¸ºé“¸é€  10,000 ä¸ªä¼ ç»Ÿ NFT æ‰€éœ€æˆæœ¬çš„ä¸€å°éƒ¨åˆ†ï¼ˆæ³¨ï¼šå¦‚æœæ‚¨è®¡åˆ’é“¸é€ å¤§é‡çš„ NFTï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°è¯•å°†è¿™äº›æŒ‡ä»¤æ‰¹å¤„ç†ä¸ºæ›´å°‘çš„æ€»äº¤æ˜“ï¼‰ã€‚

å¦‚æœæ‚¨éœ€è¦æ›´å¤šæ—¶é—´æ¥å®Œæˆè¿™ä¸ªå®éªŒï¼Œè¯·éšæ—¶å†æ¬¡é˜…è¯»æˆ–æŸ¥çœ‹[å®éªŒä»“åº“](https://github.com/Unboxed-Software/solana-cnft-demo/tree/solution)ä¸­ `solution` åˆ†æ”¯ä¸Šçš„è§£å†³æ–¹æ¡ˆä»£ç ã€‚

## æŒ‘æˆ˜

ç°åœ¨è½®åˆ°æ‚¨è‡ªå·±å°è¯•è¿™äº›æ¦‚å¿µäº†ï¼æˆ‘ä»¬ä¸ä¼šåœ¨è¿™ä¸€ç‚¹ä¸Šè¿‡äºå…·ä½“åœ°è§„å®šï¼Œä½†ä»¥ä¸‹æ˜¯ä¸€äº›æƒ³æ³•ï¼š

1. åˆ›å»ºæ‚¨è‡ªå·±çš„ç”Ÿäº§ cNFT æ”¶è—å“
2. ä¸ºæœ¬è¯¾å®éªŒæ„å»ºä¸€ä¸ª UIï¼Œä½¿æ‚¨å¯ä»¥é“¸é€  cNFT å¹¶å°†å…¶æ˜¾ç¤ºå‡ºæ¥
3. çœ‹çœ‹æ‚¨æ˜¯å¦å¯ä»¥åœ¨é“¾ä¸Šç¨‹åºä¸­å¤åˆ¶å®éªŒè„šæœ¬çš„ä¸€äº›åŠŸèƒ½ï¼Œå³ç¼–å†™ä¸€ä¸ªå¯ä»¥é“¸é€  cNFT çš„ç¨‹åº


## å®Œæˆäº†å®éªŒï¼Ÿ

å°†æ‚¨çš„ä»£ç æ¨é€åˆ° GitHubï¼Œå¹¶[å‘Šè¯‰æˆ‘ä»¬æ‚¨å¯¹æœ¬è¯¾ç¨‹çš„æƒ³æ³•](https://form.typeform.com/to/IPH0UGz7#answers-lesson=db156789-2400-4972-904f-40375582384a)ï¼
